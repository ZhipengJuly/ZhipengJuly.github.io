<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ShymanZhu’s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="To be a geek">
<meta property="og:type" content="website">
<meta property="og:title" content="ShymanZhu’s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="ShymanZhu’s blog">
<meta property="og:description" content="To be a geek">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ShymanZhu’s blog">
<meta name="twitter:description" content="To be a geek">
  
    <link rel="alternate" href="/atom.xml" title="ShymanZhu’s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ShymanZhu’s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Android架构组件（三）——ViewModel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/28/Android架构组件（三）——ViewModel/" class="article-date">
  <time datetime="2017-12-27T22:08:30.000Z" itemprop="datePublished">2017-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/28/Android架构组件（三）——ViewModel/">Android架构组件（三）——ViewModel</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>上一篇文章讲到了Android架构组件之LiveData（<a href="http://shymanzhu.com/2017/12/23/Android%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94LiveData/" target="_blank" rel="external">Android架构组件（二）——LiveData</a>)，现在我们再来看看另一个成员ViewModel。</p>
</blockquote>
<h2 id="ViewModel是什么？"><a href="#ViewModel是什么？" class="headerlink" title="ViewModel是什么？"></a>ViewModel是什么？</h2><p>&emsp;ViewModel，从字面上理解的话，我们也能想到它肯定是跟视图(View)以及数据(Model)相关的。正像它字面意思一样，它是负责准备和管理和UI组件(Fragment/Activity)相关的数据类，也就是说ViewModel是用来管理UI相关的数据的。同时ViewModel还可以用来负责UI组件间的通信，这一点后面我们会有例子说明。</p>
<h2 id="为什么需要ViewModel？"><a href="#为什么需要ViewModel？" class="headerlink" title="为什么需要ViewModel？"></a>为什么需要ViewModel？</h2><p>&emsp;在看过前面两篇介绍<a href="http://shymanzhu.com/2017/12/02/Android%20%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94Lifecycle-Aware%20Components/" target="_blank" rel="external">Lifecycle</a>和<a href="http://shymanzhu.com/2017/12/23/Android%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94LiveData/" target="_blank" rel="external">LiveData</a>的内容后，这个问题的基本就不用回答了。既然ViewModel是用来管理和UI组件有关的数据的，而LiveData又是这些数据的持有类，所以在使用LiveData的时候，就自然想到要使用ViewModel了。另外从ViewModel的定义，我们也能看到ViewModel还可以用于UI组件间的通信，回想下当初面试官问你Fragment之间怎么通信的问题，掌握ViewModel后就多了一种高逼格的回答了。</p>
<h2 id="ViewModel基本使用"><a href="#ViewModel基本使用" class="headerlink" title="ViewModel基本使用"></a>ViewModel基本使用</h2><p>&emsp;前面在讲解LiveData时，我们已经使用了ViewModel，所以它的基本使用，在这里就不在赘述了，忘了的同学可以重新去翻一翻<a href="http://shymanzhu.com/2017/12/02/Android%20%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94Lifecycle-Aware%20Components/" target="_blank" rel="external">Android架构组件（二）——LiveData</a>。我们主要看下ViewModel的生命周期，以及它用于组件间通信的使用。</p>
<h3 id="ViewModel生命周期"><a href="#ViewModel生命周期" class="headerlink" title="ViewModel生命周期"></a>ViewModel生命周期</h3><p>&emsp;我们看看ViewModel的生命周期，在官方文档中，用下面这张图来描述ViewModel的生命周期。</p>
<p><img src="https://developer.android.google.cn/images/topic/libraries/architecture/viewmodel-lifecycle.png" alt=""></p>
<p>&emsp;上图是用Activity作为例子，左侧表示Activity的生命周期状态，右侧绿色部分表示ViewModel的生命周期范围。当屏幕旋转的时候，Activity会被recreate，Activity会经过几个生命周期方法，但是这个时候ViewModel还是之前的对象，并没有被重新创建，只有当Activity的finish()方法被调用时，ViewModel.onCleared()方法会被调用，对象才会被销毁。这张图很好的描述了是当Activity被recreate时，ViewModel的生命周期。</p>
<p>&emsp; 另外，有个注意的地方：<strong>在ViewModel中不要持有Activity的引用</strong>。为什么要注意这一点呢？从上面的图我们看到，当Activity被recreate时，ViewModel对象并没有被销毁，如果Model持有Activity的引用时就可能会导致内存泄漏。那如果你要使用到Context对象怎么办呢，那就使用ViewModel的子类AndroidViewModel吧。</p>
<h3 id="用于组件间通信"><a href="#用于组件间通信" class="headerlink" title="用于组件间通信"></a>用于组件间通信</h3><p>&emsp; 下面我们看下ViewModel用于Fragment之间通信的例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by shymanzhu on 2017/12/26.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommunicateViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"CommunicateViewModel"</span>;</div><div class="line">    <span class="keyword">private</span> MutableLiveData&lt;String&gt; mNameLiveData;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> LiveData&lt;String&gt; <span class="title">getName</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (mNameLiveData == <span class="keyword">null</span>) &#123;</div><div class="line">            mNameLiveData = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mNameLiveData;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (mNameLiveData != <span class="keyword">null</span>) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"setName: "</span> + name);</div><div class="line">            mNameLiveData.setValue(name);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCleared</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCleared();</div><div class="line">        mNameLiveData = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by shymanzhu on 2017/12/26.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentOne</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> CommunicateViewModel mCommunicateViewModel;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FragmentOne <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FragmentOne();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mCommunicateViewModel = ViewModelProviders.of(getActivity()).get(CommunicateViewModel.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = inflater.inflate(R.layout.fragment_one, container, <span class="keyword">false</span>);</div><div class="line">        ButterKnife.bind(<span class="keyword">this</span>, view);</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnClick</span>(R.id.btn_set_name)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onViewClicked</span><span class="params">(View v)</span></span>&#123;</div><div class="line">        <span class="keyword">switch</span> (v.getId())&#123;</div><div class="line">            <span class="keyword">case</span> R.id.btn_set_name:</div><div class="line">                mCommunicateViewModel.setName(<span class="string">"Jane"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by shymanzhu on 2017/12/26.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentTwo</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="meta">@BindView</span>(R.id.tv_name)</div><div class="line">    TextView mTvName;</div><div class="line">    <span class="keyword">private</span> CommunicateViewModel mCommunicateViewModel;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FragmentTwo <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FragmentTwo();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mCommunicateViewModel = ViewModelProviders.of(getActivity()).get(CommunicateViewModel.class);</div><div class="line">        mCommunicateViewModel.getName().observe(<span class="keyword">this</span>, name -&gt; mTvName.setText(name));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = inflater.inflate(R.layout.fragment_two, container, <span class="keyword">false</span>);</div><div class="line">        ButterKnife.bind(<span class="keyword">this</span>, view);</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp; 代码逻辑很简单，首先定义一个CommunicateViewModel类，继承自ViewModel。然后定义两个Fragment：FragmentOne和FragmentTwo。在FragmentOne中改变CommunicateViewModel中LiveData保存的数据，然后在FragmentTwo中会收到数据改变的通知。这样一个过程就完成了FragmentOne和FragmentTwo之间的一次简单的通信。至于其中的原理，相信看过<a href="http://blog.csdn.net/zhuzp_blog/article/details/78871527" target="_blank" rel="external">LiveData</a>这篇文章话，这都不是问题了。在上面的例子中有个小陷阱：在初始化mCommunicateViewModel时，ViewModelProviders.of()方法传入的是Activity对象，如果你改成Fragment对象，那FragmentTwo里就只能傻等了，永远不会收到数据改变的通知。因为如果传给方法ViewModelProviders.of()的对象不同时，最终得到的就不是同一个ViewModel对象，这一点也可以通过打印两个Fragment中的mCommunicateViewModel验证。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>&emsp; 在讲ViewModel的原理时，我们还是延续前面的传统，先理清ViewModel相关的类图，然后理清ViewModel使用的时序图，最后就是根据时序图分析源码。</p>
<h3 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h3><p>&emsp;废话不多说，直接上ViewModel相关的类图：</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/viewmodel/class_viewmodel_1.png" alt=""></p>
<ul>
<li><p>ViewModelProviders是ViewModel工具类，该类提供了通过Fragment和Activity得到ViewModel的方法，而具体实现又是有ViewModelProvider实现的。ViewModelProvider是实现ViewModel创建、获取的工具类。在ViewModelProvider中定义了一个创建ViewModel的接口类——Factory。ViewModelProvider中有个ViewModelStore对象，用于存储ViewModel对象。</p>
</li>
<li><p>ViewModelStore是存储ViewModel的类，具体实现是通过HashMap来保存ViewModle对象。</p>
</li>
<li><p>ViewModel是个抽象类，里面只定义了一个onCleared()方法，该方法在ViewModel不在被使用时调用。ViewModel有一个子类AndroidViewModel，这个类是便于要在ViewModel中使用Context对象，因为我们前面提到是不能在ViewModel中持有Activity的引用。</p>
</li>
<li><p>ViewModelStores是ViewModelStore的工厂方法类，它会关联HolderFragment，HolderFragment有个嵌套类——HolderFragmentManager。</p>
<p>​</p>
</li>
</ul>
<p>类图要说明的内容就是以上几点了，对于UML类图中的关联、聚合、组合的关系，个人觉得比较难区分，在这里找到了一个比较好的回答<a href="https://stackoverflow.com/questions/885937/what-is-the-difference-between-association-aggregation-and-composition" target="_blank" rel="external">What is the difference between association, aggregation and composition?</a></p>
<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p>&emsp;在使用ViewModel的例子中，也许你会察觉得到一个ViewModel对象需要的步骤有点多啊，怎么不直接new一个出来呢？在你看到ViewModel的类图关系后，你应该就能明白了，因为是会缓存ViewModel对象的。下面以在Fragment中得到ViewModel对象为例看下整个过程的时序图。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/viewmodel/sequency_viewmodel.png" alt="sequence viewmodle"></p>
<p>&emsp;时序图看起来比较复杂，但是它只描述了两个过程：</p>
<ul>
<li>得到ViewModel对象。</li>
<li>HolderFragment被销毁时，ViewModel收到onCleared()通知。</li>
</ul>
<p>&emsp;读者朋友们可以根据这个时序结合源码看下具体的实现，这个也是我们下面要讲的内容——<strong>源码分析</strong>。</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>&emsp;根据上面时序图中的内容，我们从两个方面着手研究下ViewModel相关源码。</p>
<h4 id="获取ViewModel对象"><a href="#获取ViewModel对象" class="headerlink" title="获取ViewModel对象"></a>获取ViewModel对象</h4><p>&emsp;得到ViweModel对象，首先是通过ViewModelProviders.of()方法得到ViewModelProvider对象，然后调用ViewModelProvider.get()方法得到ViewModel对象。</p>
<h5 id="一、得到ViewModelProvider对象"><a href="#一、得到ViewModelProvider对象" class="headerlink" title="一、得到ViewModelProvider对象"></a>一、得到ViewModelProvider对象</h5><p>&emsp;直接看ViewModelProviders类的具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelProviders</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"StaticFieldLeak"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DefaultFactory sDefaultFactory;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeFactoryIfNeeded</span><span class="params">(Application application)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sDefaultFactory == <span class="keyword">null</span>) &#123;</div><div class="line">            sDefaultFactory = <span class="keyword">new</span> DefaultFactory(application);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Application <span class="title">checkApplication</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        Application application = activity.getApplication();</div><div class="line">        <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Your activity/fragment is not yet attached to "</span></div><div class="line">                    + <span class="string">"Application. You can't request ViewModel before onCreate call."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> application;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Activity <span class="title">checkActivity</span><span class="params">(Fragment fragment)</span> </span>&#123;</div><div class="line">        Activity activity = fragment.getActivity();</div><div class="line">        <span class="keyword">if</span> (activity == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't create ViewModelProvider for detached fragment"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> activity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull Fragment fragment)</span> </span>&#123;</div><div class="line">        initializeFactoryIfNeeded(checkApplication(checkActivity(fragment)));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewModelProvider(ViewModelStores.of(fragment), sDefaultFactory);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</div><div class="line">        initializeFactoryIfNeeded(checkApplication(activity));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewModelProvider(ViewModelStores.of(activity), sDefaultFactory);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull Fragment fragment, @NonNull Factory factory)</span> </span>&#123;</div><div class="line">        checkApplication(checkActivity(fragment));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewModelProvider(ViewModelStores.of(fragment), factory);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull FragmentActivity activity,</span></span></div><div class="line">            @NonNull Factory factory) &#123;</div><div class="line">        checkApplication(activity);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewModelProvider(ViewModelStores.of(activity), factory);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFactory</span> <span class="keyword">extends</span> <span class="title">ViewModelProvider</span>.<span class="title">NewInstanceFactory</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> Application mApplication;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Creates a &#123;<span class="doctag">@code</span> DefaultFactory&#125;</div><div class="line">         *</div><div class="line">         * <span class="doctag">@param</span> application an application to pass in &#123;<span class="doctag">@link</span> AndroidViewModel&#125;</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DefaultFactory</span><span class="params">(@NonNull Application application)</span> </span>&#123;</div><div class="line">            mApplication = application;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@NonNull</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (AndroidViewModel.class.isAssignableFrom(modelClass)) &#123;</div><div class="line">                <span class="comment">//noinspection TryWithIdenticalCatches</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">return</span> modelClass.getConstructor(Application.class).newInstance(mApplication);</div><div class="line">                &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</div><div class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</div><div class="line">                &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</div><div class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.create(modelClass);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;ViewModelProviders提供了四个of()方法，四个方法功能类似，其中of(FragmentActivity activity, Factory factory)和of(Fragment fragment, Factory factory)提供了自定义创建ViewModel的方法。我们在时序图中使用of(Fragment fragment)最为研究对象，这里我们也从该方法开始研究，在该方法中主要有两个步骤。</p>
<h6 id="1，判断是否需要初始化默认的Factory"><a href="#1，判断是否需要初始化默认的Factory" class="headerlink" title="1，判断是否需要初始化默认的Factory"></a>1，判断是否需要初始化默认的Factory</h6><p>&emsp;这一过程很简单：通过调用initializeFactoryIfNeeded()方法判断是否需要初始化mDefaultFactory变量。在此之前又会判断Fragment的是否Attached to Activity，Activity的Application对象是否为空。</p>
<h6 id="2，创建一个ViewModelProvider对象。"><a href="#2，创建一个ViewModelProvider对象。" class="headerlink" title="2，创建一个ViewModelProvider对象。"></a>2，创建一个ViewModelProvider对象。</h6><p>&emsp;创建ViewModel对象看似很简单，一行代码搞定<code>new ViewModelProvider(ViewModelStores.of(fragment), sDefaultFactory)</code>。但是里面的里面的逻辑比较深，我们慢慢把它抽丝剥茧，看看有多深。</p>
<p>&emsp;先看看ViewModelStores.of()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelStore <span class="title">of</span><span class="params">(@NonNull Fragment fragment)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> holderFragmentFor(fragment).getViewModelStore();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;又是一行代码，holderFragmentFor()是HolderFragment的静态方法，HolderFragment继承自Fragment。我们先看holderFragment()方法的具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="meta">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HolderFragment <span class="title">holderFragmentFor</span><span class="params">(Fragment fragment)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sHolderFragmentManager.holderFragmentFor(fragment);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mViewModelStore; <span class="comment">//返回ViewModelStore对象</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;额，holderFragmentFor()又是一行代码，继续看HolderFragmentManager.holderFragmentFor()方法的具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function">HolderFragment <span class="title">holderFragmentFor</span><span class="params">(Fragment parentFragment)</span> </span>&#123;</div><div class="line">    FragmentManager fm = parentFragment.getChildFragmentManager();</div><div class="line">    HolderFragment holder = findHolderFragment(fm); <span class="comment">// 在activity和back stack中查找parentFragment</span></div><div class="line">    <span class="keyword">if</span> (holder != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> holder;</div><div class="line">    &#125;</div><div class="line">    holder = mNotCommittedFragmentHolders.get(parentFragment); </div><div class="line">    <span class="keyword">if</span> (holder != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> holder;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 注册Fragment生命周期回调</span></div><div class="line">    parentFragment.getFragmentManager()</div><div class="line">            .registerFragmentLifecycleCallbacks(mParentDestroyedCallback, <span class="keyword">false</span>);</div><div class="line">    holder = createHolderFragment(fm); <span class="comment">//创建HolderFragment对象。</span></div><div class="line">    mNotCommittedFragmentHolders.put(parentFragment, holder);</div><div class="line">    <span class="keyword">return</span> holder;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> FragmentLifecycleCallbacks mParentDestroyedCallback =</div><div class="line">    <span class="keyword">new</span> FragmentLifecycleCallbacks() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFragmentDestroyed</span><span class="params">(FragmentManager fm, Fragment parentFragment)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.onFragmentDestroyed(fm, parentFragment);</div><div class="line">            HolderFragment fragment = mNotCommittedFragmentHolders.remove(</div><div class="line">                    parentFragment);</div><div class="line">            <span class="keyword">if</span> (fragment != <span class="keyword">null</span>) &#123;</div><div class="line">                Log.e(LOG_TAG, <span class="string">"Failed to save a ViewModel for "</span> + parentFragment);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HolderFragment <span class="title">createHolderFragment</span><span class="params">(FragmentManager fragmentManager)</span> </span>&#123;</div><div class="line">    HolderFragment holder = <span class="keyword">new</span> HolderFragment(); <span class="comment">// 创建HolderFragment对象</span></div><div class="line">    fragmentManager.beginTransaction().add(holder, HOLDER_TAG).commitAllowingStateLoss();</div><div class="line">    <span class="keyword">return</span> holder;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HolderFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//这个是关键，这就使得Activity被recreate时，Fragment的onDestroy()和onCreate()不会被调用</span></div><div class="line">    setRetainInstance(<span class="keyword">true</span>); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;在createHolderFragment()方法中，你也许发现调用FragmentTransaction.add()方法并没有传一个定义在layout文件中的id进去，而且你去看HolderFragment并没有重写Fragment.onCreateView()方法。这个有点反常，这是为什么呢？ 这个疑惑可以从HolderFragment()构造方法中得到解答。在构造方法中调用了setRetainInstance(true)方法，该方法会使得HolderFragment所在的Activity被recreate时，HolderFragment不会被recreate，自然它就不会走onDestroy()、onCreate()方法。为什么不让HolderFragment被recreate呢？这里先卖个关子，等到在讲时序图中步骤二时我们再讲。</p>
<p>&emsp;到此为止，我们已经得到了ViewStore对象，前面我们在创建ViewModelProvider对象是通过这行代码实现的<code>new ViewModelProvider(ViewModelStores.of(fragment), sDefaultFactory)</code>现在再看下ViewModelProvider的构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(@NonNull ViewModelStore store, @NonNull Factory factory)</span> </span>&#123;</div><div class="line">    mFactory = factory;</div><div class="line">    <span class="keyword">this</span>.mViewModelStore = store; <span class="comment">// 这个ViewStore对象实际上是HolderFragment中的ViewStore对象。</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="二、得到ViewModel对象"><a href="#二、得到ViewModel对象" class="headerlink" title="二、得到ViewModel对象"></a>二、得到ViewModel对象</h5><p>&emsp;在上面我们已经得到了ViewModelProvider对象，现在就可以通过ViewModelProvider.get()方法得到ViewModel对象，继续看下该方法的具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</div><div class="line">    String canonicalName = modelClass.getCanonicalName();</div><div class="line">    <span class="keyword">if</span> (canonicalName == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Local and anonymous classes can not be ViewModels"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> get(DEFAULT_KEY + <span class="string">":"</span> + canonicalName, modelClass);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(@NonNull String key, @NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</div><div class="line">    ViewModel viewModel = mViewModelStore.get(key);  <span class="comment">//从缓存中查找是否有已有ViewModel对象。</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</div><div class="line">        <span class="comment">//noinspection unchecked</span></div><div class="line">        <span class="keyword">return</span> (T) viewModel;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//noinspection StatementWithEmptyBody</span></div><div class="line">        <span class="keyword">if</span> (viewModel != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    viewModel = mFactory.create(modelClass); <span class="comment">//创建ViewModel对象，然后缓存起来。</span></div><div class="line">    mViewModelStore.put(key, viewModel);</div><div class="line">    <span class="comment">//noinspection unchecked</span></div><div class="line">    <span class="keyword">return</span> (T) viewModel;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp; ViewModelProvider.get()方法比较简单，该说的都在注释中写明了。最后我们看下ViewModelStore类的具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelStore</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, ViewModel viewModel)</span> </span>&#123;</div><div class="line">        ViewModel oldViewModel = mMap.get(key);</div><div class="line">        <span class="keyword">if</span> (oldViewModel != <span class="keyword">null</span>) &#123;</div><div class="line">            oldViewModel.onCleared();</div><div class="line">        &#125;</div><div class="line">        mMap.put(key, viewModel);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">final</span> ViewModel <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mMap.get(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     *  Clears internal storage and notifies ViewModels that they are no longer used.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</div><div class="line">            vm.onCleared();</div><div class="line">        &#125;</div><div class="line">        mMap.clear();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;ViewModelStore是缓存ViewModel的类，put()、get()方法用于存取ViewModel对象，另外提供了clear()方法用于清空缓存的ViewModel对象，在该方法中会调用ViewModel.onCleared()方法通知ViewModel对象不再被使用。</p>
<p>####ViewModel收到onCleared()通知。</p>
<p>&emsp;在前面我们提到，在HolderFragment的构造方法中调用了<code>setRetainInstance(true);</code>目的是为了在其所在的Activity被recreate时，HolderFragment不会被recreate，为什么要这么做呢（之前面卖的关子），那就要看下它的onDestroy()方法了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    mViewModelStore.clear();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;在onDestroy()方法中调用了ViewModelStore.clear()方法，我们知道在该方法中会调用ViewModel的onCleared()方法。在你看了HolderFragment源码后，或许你会有个疑问，mViewModelStore保存的ViewModel对象是在哪里添加的呢？ 细心的话，你会发现在ViewModelProvider的构造方法中，已经将HolderFragment中的ViwModelStore对象mViewModelStore的引用传递给了ViewModelProvider中的mViewModelStore，而在ViewModelProvider.get()方法中会向mViewModelStore添加ViewModel对象。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;总结，额….还是由你们来完成，抛一个问题来作为总结吧：为什么ViewModel的生命周期比使用它的Activity/Fragment的生命周期更长呢？ 如果你有认真看完这篇文章，我相信这个问题是难不倒你，如果没想到，那就多看几遍吧。最后，提供一张图来帮助你想这个问题。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/viewmodel/lifecyle_viewmodel.png" alt="lifecyle_viewmodel"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/28/Android架构组件（三）——ViewModel/" data-id="cjbu8bw3u00009nvgbsbdyu8i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ViewModel/">ViewModel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android架构组件（二）——LiveData" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/23/Android架构组件（二）——LiveData/" class="article-date">
  <time datetime="2017-12-22T21:35:20.000Z" itemprop="datePublished">2017-12-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/23/Android架构组件（二）——LiveData/">Android 架构组件（二）——LiveData</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>上一篇文章讲到了Android架构组件之一Lifecycle组件（<a href="http://shymanzhu.com/2017/12/02/Android%20%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94Lifecycle-Aware%20Components/#more" target="_blank" rel="external">Android 架构组件（一）——Lifecycle-Aware Components</a>)，现在我们再来看看另一个成员LiveData。</p>
</blockquote>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>&emsp;简单地说，LiveData是一个数据持有类。它具有以下特点：</p>
<ul>
<li><p>数据可以被观察者订阅；</p>
</li>
<li><p>能够感知组件（Fragment、Activity、Service）的生命周期；</p>
</li>
<li><p>只有在组件出于激活状态（<a href="https://developer.android.google.cn/reference/android/arch/lifecycle/Lifecycle.State.html#STARTED" target="_blank" rel="external">STARTED</a>、<a href="https://developer.android.google.cn/reference/android/arch/lifecycle/Lifecycle.State.html#RESUMED" target="_blank" rel="external">RESUMED</a>）才会通知观察者有数据更新；</p>
<p>​</p>
<p><strong>PS: 文中提到的“组件”皆指实现了LifecycleOwner接口Fragment、Activity。</strong></p>
</li>
</ul>
<h2 id="为什么需要LiveData"><a href="#为什么需要LiveData" class="headerlink" title="为什么需要LiveData"></a>为什么需要LiveData</h2><p>&emsp;从LiveData具有的特点，我们就能联想到它能够解决我们遇到的什么问题。LiveData具有以下优点：</p>
<ul>
<li><p>能够保证数据和UI统一</p>
<p>&emsp;这个和LiveData采用了观察者模式有关，LiveData是被观察者，当数据有变化时会通知观察者（UI）。</p>
</li>
<li><p>减少内存泄漏</p>
<p>&emsp;这是因为LiveData能够感知到组件的生命周期，当组件处于DESTROYED状态时，观察者对象会被清除掉。</p>
</li>
<li><p>当Activity停止时不会引起崩溃</p>
<p>&emsp;这是因为组件处于非激活状态时，不会收到LiveData中数据变化的通知。</p>
</li>
<li><p>不需要额外的手动处理来响应生命周期的变化</p>
<p>&emsp;这一点同样是因为LiveData能够感知组件的生命周期，所以就完全不需要在代码中告诉LiveData组件的生命周期状态。</p>
</li>
<li><p>组件和数据相关的内容能实时更新</p>
<p>&emsp;组件在前台的时候能够实时收到数据改变的通知，这是可以理解的。当组件从后台到前台来时，LiveData能够将最新的数据通知组件，这两点就保证了组件中和数据相关的内容能够实时更新。</p>
</li>
<li><p>针对configuration change时，不需要额外的处理来保存数据</p>
<p>&emsp; 我们知道，当你把数据存储在组件中时，当configuration change（比如语言、屏幕方向变化）时，组件会被recreate，然而系统并不能保证你的数据能够被恢复的。当我们采用LiveData保存数据时，因为数据和组件分离了。当组件被recreate，数据还是存在LiveData中，并不会被销毁。</p>
</li>
<li><p>资源共享</p>
<p>&emsp;通过继承LiveData类，然后将该类定义成单例模式，在该类封装监听一些系统属性变化，然后通知LiveData的观察者，这个在<strong>继承LiveData</strong>中会看到具体的例子。</p>
</li>
</ul>
<h2 id="LiveData使用"><a href="#LiveData使用" class="headerlink" title="LiveData使用"></a>LiveData使用</h2><p>&emsp;在了解LiveData定义和优点后，那它到底怎么应用呢？LiveData有几种使用方式：</p>
<ul>
<li>使用LiveData对象</li>
<li>继承LiveData类</li>
</ul>
<h3 id="使用LiveData对象"><a href="#使用LiveData对象" class="headerlink" title="使用LiveData对象"></a>使用LiveData对象</h3><p>&emsp; 使用LiveData对象主要有以下几个步骤：</p>
<ol>
<li>创建保存特定数据类型的LiveData实例；</li>
<li>创建Observer对象，作为参数传入LiveData.observe()方法添加观察者；</li>
<li>更新Livedata对象存储的数据；</li>
</ol>
<h4 id="创建LiveData实例"><a href="#创建LiveData实例" class="headerlink" title="创建LiveData实例"></a>创建LiveData实例</h4><p>&emsp;Android文档中建议LiveData配合ViewModel使用更加哦，其实呢，你也可以不使用ViewModel，<strong>但是一定要做到LiveData中保存的数据和组件分离</strong>，至于原因，前面我们已经提到过了。下面是在ViewModel中创建LiveData实例的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by shymanzhu on 2017/12/20.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NameViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span></span>&#123;</div><div class="line">    <span class="comment">// Create a LiveData with a String</span></div><div class="line">    <span class="keyword">private</span> MutableLiveData&lt;String&gt; mCurrentName;</div><div class="line">    <span class="comment">// Create a LiveData with a String list</span></div><div class="line">    <span class="keyword">private</span> MutableLiveData&lt;List&lt;String&gt;&gt; mNameListData;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> MutableLiveData&lt;String&gt; <span class="title">getCurrentName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mCurrentName == <span class="keyword">null</span>) &#123;</div><div class="line">            mCurrentName = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mCurrentName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> MutableLiveData&lt;List&lt;String&gt;&gt; getNameList()&#123;</div><div class="line">        <span class="keyword">if</span> (mNameListData == <span class="keyword">null</span>) &#123;</div><div class="line">            mNameListData = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mNameListData;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;在NameViewModel中创建了两个MutableLiveData(MutableLiveData是LiveData的子类)实例，分别存储当前姓名、姓名列表；两个实例通过NameViewModel中的getter方法得到。</p>
<h4 id="创建Observer对象，添加观察者"><a href="#创建Observer对象，添加观察者" class="headerlink" title="创建Observer对象，添加观察者"></a>创建Observer对象，添加观察者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by shymanzhu on 2017/12/19.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveDataFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"LiveDataFragment"</span>;</div><div class="line">    <span class="keyword">private</span> NameViewModel mNameViewModel;</div><div class="line">    <span class="meta">@BindView</span>(R.id.tv_name)</div><div class="line">    TextView mTvName;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LiveDataFragment <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LiveDataFragment();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mNameViewModel = ViewModelProviders.of(<span class="keyword">this</span>).get(NameViewModel.class);</div><div class="line">        mNameViewModel.getCurrentName().observe(<span class="keyword">this</span>,(String name) -&gt; &#123;</div><div class="line">            mTvName.setText(name);</div><div class="line">            Log.d(TAG, <span class="string">"currentName: "</span> + name);</div><div class="line">        &#125;); <span class="comment">// 订阅LiveData中当前Name数据变化，以lambda形式定义Observer</span></div><div class="line">        mNameViewModel.getNameList().observe(<span class="keyword">this</span>, (List&lt;String&gt; nameList) -&gt; &#123;</div><div class="line">            <span class="keyword">for</span> (String item : nameList) &#123;</div><div class="line">                Log.d(TAG, <span class="string">"name: "</span> + item);</div><div class="line">            &#125;</div><div class="line">        &#125;); <span class="comment">// 订阅LiveData中Name列表数据变化，以lambda形式定义Observer</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        View view = inflater.inflate(R.layout.layout_livedata, container, <span class="keyword">false</span>);</div><div class="line">        ButterKnife.bind(<span class="keyword">this</span>, view);</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp; 在onCreate()方法中通过LiveData.observe()方法添加观察者，当数据变化时会通过回调方法通知观察者，在lambda表达式中更新当前姓名和打印姓名列表。</p>
<h4 id="更新LiveData中的数据"><a href="#更新LiveData中的数据" class="headerlink" title="更新LiveData中的数据"></a>更新LiveData中的数据</h4><p>&emsp; 在上面我们已经订阅了LiveData数据变化，现在我们看下如果LiveData数据变化时，上面的lambda表达式中是否会受到更新的通知。我们在LiveDataFragment中增加两个按钮来改变LiveData中的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@OnClick</span>(&#123;R.id.btn_change_name, R.id.btn_update_list&#125;)</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">onClicked</span><span class="params">(View view)</span></span>&#123;</div><div class="line">    <span class="keyword">switch</span> (view.getId())&#123;</div><div class="line">        <span class="keyword">case</span> R.id.btn_change_name:</div><div class="line">            mNameViewModel.getCurrentName().setValue(<span class="string">"Jane"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> R.id.btn_update_list:</div><div class="line">            List&lt;String&gt; nameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</div><div class="line">                nameList.add(<span class="string">"Jane&lt;"</span> + i + <span class="string">"&gt;"</span>);</div><div class="line">            &#125;</div><div class="line">            mNameViewModel.getNameList().setValue(nameList);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;代码很简单，在两个按钮的点击事件中通过LiveData.setValue()方法来改变LiveData中保存的数据。当点击这两个按钮的时候，我们会发现在onCreate()方法中会收相应到数据改变的回调。</p>
<h3 id="继承LiveData类"><a href="#继承LiveData类" class="headerlink" title="继承LiveData类"></a>继承LiveData类</h3><p>&emsp;除了直接使用LiveDatad对象外，我们还可以通过集成LiveData类来定义适合特定需求的LiveData。下面继承LiveData类的例子，验证下LiveData的其中一个优点——<strong>资源共享</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by shymanzhu on 2017/12/19.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLiveData</span> <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyLiveData"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MyLiveData sData;</div><div class="line">    <span class="keyword">private</span> WeakReference&lt;Context&gt; mContextWeakReference;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyLiveData <span class="title">getInstance</span><span class="params">(Context context)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span> (sData == <span class="keyword">null</span>)&#123;</div><div class="line">            sData = <span class="keyword">new</span> MyLiveData(context);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sData;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MyLiveData</span><span class="params">(Context context)</span></span>&#123;</div><div class="line">        mContextWeakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onActive();</div><div class="line">        registerReceiver();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInactive</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onInactive();</div><div class="line">        unregisterReceiver();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerReceiver</span><span class="params">()</span> </span>&#123;</div><div class="line">        IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</div><div class="line">        intentFilter.addAction(WifiManager.RSSI_CHANGED_ACTION);</div><div class="line">        mContextWeakReference.get().registerReceiver(mReceiver, intentFilter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unregisterReceiver</span><span class="params">()</span> </span>&#123;</div><div class="line">        mContextWeakReference.get().unregisterReceiver(mReceiver);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> BroadcastReceiver mReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">            String action = intent.getAction();</div><div class="line">            Log.d(TAG, <span class="string">"action = "</span> + action);</div><div class="line">            <span class="keyword">if</span> (WifiManager.RSSI_CHANGED_ACTION.equals(action)) &#123;</div><div class="line">                <span class="keyword">int</span> wifiRssi = intent.getIntExtra(WifiManager.EXTRA_NEW_RSSI, -<span class="number">200</span>);</div><div class="line">                <span class="keyword">int</span> wifiLevel = WifiManager.calculateSignalLevel(</div><div class="line">                        wifiRssi, <span class="number">4</span>);</div><div class="line">                sData.setValue(wifiLevel);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;MyLiveData是个继承了LiveData的单例类，在onActive()和onInactive()方法中分别注册和反注册Wifi信号强度的广播。然后在广播接收器中更新MyLiveData对象。在使用的时候就可以通过MyLiveData.getInstance()方法，然后通过调用observe()方法来添加观察者对象，订阅Wifi信息强度变化。</p>
<ul>
<li>onActive()，此方法是当处于激活状态的observer个数从0到1时，该方法会被调用。</li>
<li>onInactive() ，此方法是当处于激活状态的observer个数从1变为0时，该方法会被调用。</li>
</ul>
<h2 id="LiveDta原理"><a href="#LiveDta原理" class="headerlink" title="LiveDta原理"></a>LiveDta原理</h2><p>&emsp;对于某个组件的原理解析，个人现在比较习惯于从类图、时序、源码几个方面着手分析。下面的内容也是从这几点依次展开的</p>
<h3 id="类关系图"><a href="#类关系图" class="headerlink" title="类关系图"></a>类关系图</h3><p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/livedata/class_livedata1.png" alt="LiveDta类图"></p>
<p>&emsp;LiveData的类关系图相对比较简单，从上面的类图我们就能看到。和LiveData组件相关的类和接口有：LiveData类、Observer接口、GenericLifecycleObserver接口。LiveData类是个抽象类，但是它没有抽象方法，抽象类有个特点是：不能在抽象类中实例化自己。为什么LiveData会被定义成abstract而又没有抽象方法呢，这个…我也不知道，看了下LiveData的提交记录，是在将hasObservers()替换getObserverCount()方法时将LiveData改成了abstract，在此之前它是被定义为public，可以翻墙的可以看下这里的修改<a href="https://android.googlesource.com/platform/frameworks/support/+/abf6c87826e1a86fed71d945dc7e7f1aa643ea6c%5E%21/#F2" target="_blank" rel="external">记录</a></p>
<ul>
<li><p>MediatorLiveData继承自MutableLiveData，MutableLiveData继承自LiveData。MediatorLiveData可以看成是多个LiveData的代理，当将多个LiveData添加到MediatorLiveData，任何一个LiveData数据发生变化时，MediatorLiveData都会收到通知。</p>
</li>
<li><p>LiveData有个内部类LifecycleBoundObserver，它实现了GenericLifecycleObserver，而GenericLifecycleObserver继承了LifecycleObserver接口。在<a href="http://shymanzhu.com/2017/12/02/Android%20%E6%9E%B6%E6%9E%84%E7%BB%84%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94Lifecycle-Aware%20Components/#more" target="_blank" rel="external">这里</a>可以回顾下Lifecycle组件相关的内容。当组件（Fragment、Activity）生命周期变化时会通过onStateChanged()方法回调过来。</p>
</li>
<li><p>Observer接口就是观察者，其中定义了LiveData数据变化的回调方法onChanged()。</p>
<p>​</p>
</li>
</ul>
<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/livedata/sequence_livedate.png" alt="LiveData时序图"></p>
<p>&emsp;LiveData主要涉及到的时序有三个：</p>
<ul>
<li>在Fragment/Activity中通过LiveData.observer()添加观察者（observer()方法中的第二个参数）。</li>
<li>根据Fragment/Activity生命周期发生变化时，移除观察者或者通知观察者更新数据。</li>
<li>当调用LiveData的setValue()、postValue()方法后，通知观察者更新数据。</li>
</ul>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><p>&emsp;根据LiveData主要涉及到的三个时序的内容，我们通过源码看下它具体的实现。</p>
<h4 id="添加观察者"><a href="#添加观察者" class="headerlink" title="添加观察者"></a>添加观察者</h4><p>&emsp;LiveData提供了两种添加观察者的方法：observeForever()、observe()。</p>
<ul>
<li>observeForever()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</div><div class="line">    observe(ALWAYS_ON, observer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;从方法的命名，我们也能对它的功能略知一二，通过observeForever()添加观察者，观察者会一直受到数据的变化回到，而不是在组件处于STARTED和RESUMED状态下才会收到，因为这是LifecycleOwner对象就不再是组件了，而是ALWAYS_ON；另外通过该方法添加观察者后，要手动调用removeObserver()方法来停止观察者接收回调通知。observeForever()方法体很简单，调用了observe()方法，传入的一个参数是ALWAYS_ON常量，重点看下ALWAYS_ON常量是个啥东东。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LifecycleOwner ALWAYS_ON = <span class="keyword">new</span> LifecycleOwner() &#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> LifecycleRegistry mRegistry = init();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> LifecycleRegistry <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        LifecycleRegistry registry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</div><div class="line">        registry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</div><div class="line">        registry.handleLifecycleEvent(Lifecycle.Event.ON_START);</div><div class="line">        registry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</div><div class="line">        <span class="keyword">return</span> registry;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRegistry;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>&emsp;ALWAYS_ON是LifecycleOwner常量，在init方法中会初始化Lifecycle的生命周期状态，完了之后，就没有改变过Lifecycle的生命周期状态了，这也就是为什么通过observeForever()添加观察者是，当数据改变时不管组件处于什么状态都会收到回调的原因，除非手动将观察者移除。</p>
<ul>
<li>observe()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</div><div class="line">        <span class="comment">// ignore</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//将LifecycleOwner对象和Observer对象封装成LifecycleBoundObserver对象。</span></div><div class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</div><div class="line">    <span class="comment">// mObservers可以理解成一个类似Map的容器，putIfAbsent()方法是判断容器中的observer（key）</span></div><div class="line">    <span class="comment">// 是否有已经和wrapper(value)关联，如果已经关联则返回关联值，否则关联并返回wrapper。</span></div><div class="line">    LifecycleBoundObserver existing = mObservers.putIfAbsent(observer, wrapper);</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; existing.owner != wrapper.owner) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add the same observer"</span></div><div class="line">                + <span class="string">" with different lifecycles"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    owner.getLifecycle().addObserver(wrapper); <span class="comment">//条件LifecycleOwner的生命周期观察者</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp; 该方法也比较简单，主要逻辑都在注释中说明了，就不再赘述了。</p>
<h4 id="组件（Fragment-Activity）生命周期发生变化"><a href="#组件（Fragment-Activity）生命周期发生变化" class="headerlink" title="组件（Fragment/Activity）生命周期发生变化"></a>组件（Fragment/Activity）生命周期发生变化</h4><p>&emsp;在LiveData.observe()方法中添加了组件（实现了LifecycleOwner接口的Fragment和Activity）生命周期观察者。而这个观察者就是LifecycleBoundObserver对象，下面我们看下LifecycleBoundObserver具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleBoundObserver</span> <span class="keyword">implements</span> <span class="title">GenericLifecycleObserver</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> LifecycleOwner owner;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Observer&lt;T&gt; observer;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> active;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> lastVersion = START_VERSION;</div><div class="line"></div><div class="line">    LifecycleBoundObserver(LifecycleOwner owner, Observer&lt;T&gt; observer) &#123;</div><div class="line">        <span class="keyword">this</span>.owner = owner;</div><div class="line">        <span class="keyword">this</span>.observer = observer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span> </span>&#123;</div><div class="line">        <span class="comment">// LifecycleOwner对象生命周期发生变化时，会通过该回调方法通知过来。</span></div><div class="line">        <span class="comment">// 如果当前处于Lifecycle.State.DESTROYED时，会自动将观察者移除。</span></div><div class="line">        <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</div><div class="line">            removeObserver(observer);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 判断是否处于actived状态，并将结果作为参数传递给activeStateChanged()</span></div><div class="line">        activeStateChanged(isActiveState(owner.getLifecycle().getCurrentState()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (newActive == active) &#123; <span class="comment">//新状态和之前状态相同，不处理</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        active = newActive;</div><div class="line">        <span class="keyword">boolean</span> wasInactive = LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span>;</div><div class="line">        LiveData.<span class="keyword">this</span>.mActiveCount += active ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (wasInactive &amp;&amp; active) &#123; <span class="comment">//处于激活状态的observer个数从0到1</span></div><div class="line">            onActive();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !active) &#123; <span class="comment">//处于激活状态的observer个数从1变为0</span></div><div class="line">            onInactive();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (active) &#123;</div><div class="line">            dispatchingValue(<span class="keyword">this</span>); </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> &emsp;通过observe()方法添加观察者时，当组件（Fragment/Activity）生命周期发生变化时，onStateChanged()方法会被调用。如果通过observeForever()方法添加观察者时，只有在常量ALWAYS_ON初始化的时候，onStateChanged()方法会被调用三次（CREATED、STARTED、RESUMED），后面就不会收到DESTROYED的状态，这也就是为什么要通过removeObserver()方法手动移除观察者的原因。</p>
<p>&emsp;onActive()和onInactive()都是空实现的方法，继承类可以选择去实现。我们看下dispatchingValue()方法的具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(@Nullable LifecycleBoundObserver initiator)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</div><div class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    mDispatchingValue = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;  <span class="comment">// initiator不为空，考虑通知回调</span></div><div class="line">            considerNotify(initiator);</div><div class="line">            initiator = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// initiator为空，考虑通知mObservers容器中对象回调</span></div><div class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;T&gt;, LifecycleBoundObserver&gt;&gt; iterator =</div><div class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</div><div class="line">                considerNotify(iterator.next().getValue());</div><div class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</div><div class="line">    mDispatchingValue = <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(LifecycleBoundObserver observer)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!observer.active) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!isActiveState(observer.owner.getLifecycle().getCurrentState())) &#123;</div><div class="line">        observer.activeStateChanged(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (observer.lastVersion &gt;= mVersion) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    observer.lastVersion = mVersion;</div><div class="line">    <span class="comment">// 最终回调的地方，也就是调用observe()或者observeForever()是传入的Observer对象。</span></div><div class="line">    observer.observer.onChanged((T) mData);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="改变LiveData数据"><a href="#改变LiveData数据" class="headerlink" title="改变LiveData数据"></a>改变LiveData数据</h4><p>&emsp; LiveData提供了两种改变数据的方法：setValue()和postValue()。区别是setValue()要在主线程中调用，而postValue()既可在主线程也可在子线程中调用。我们先看setValue()方法的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">    assertMainThread(<span class="string">"setValue"</span>); <span class="comment">//判断当前线程是否是主线程，不是主线程就抛出异常</span></div><div class="line">    mVersion++;</div><div class="line">    mData = value;</div><div class="line">    dispatchingValue(<span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再看下postValue()方法的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> postTask;</div><div class="line">    <span class="keyword">synchronized</span> (mDataLock) &#123;</div><div class="line">        postTask = mPendingData == NOT_SET;</div><div class="line">        mPendingData = value;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!postTask) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 会在主线程中执行  mPostValueRunnable中的内容。</span></div><div class="line">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable); </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable mPostValueRunnable = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        Object newValue;</div><div class="line">        <span class="keyword">synchronized</span> (mDataLock) &#123;</div><div class="line">            newValue = mPendingData;</div><div class="line">            mPendingData = NOT_SET;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 在主线程中调用setValue()方法</span></div><div class="line">        setValue((T) newValue); </div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>&emsp;postValue()方法通过ArchTaskExecutor实现在主线程中执行mPostValueRunnable对象中的内容，而在mPostValueRunnable中最终会调用setValue()方法来实现改变LiveData存储的数据。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;整个流程下来，你会发现其实LiveData的原理还是蛮简单的。当然LiveData还有更多的使用方法，具体的内容只有在你使用到的时候再去研究吧，我先抛砖引玉，剩下的就看你们的啦……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/23/Android架构组件（二）——LiveData/" data-id="cjbu7s6r400006wvgs7rdab9h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LiveData/">LiveData</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android 架构组件（一）——Lifecycle-Aware Components" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/02/Android 架构组件（一）——Lifecycle-Aware Components/" class="article-date">
  <time datetime="2017-12-01T20:45:01.000Z" itemprop="datePublished">2017-12-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/02/Android 架构组件（一）——Lifecycle-Aware Components/">Android 架构组件（一）——Lifecycle-Aware Components</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>有一天“谷歌开发者”官微推送了<a href="http://mp.weixin.qq.com/s/9rC_5GhdAA_EMEbWKJT5vQ" target="_blank" rel="external">《正式发布 Android 架构组件 1.0 稳定版 | 附带中文介绍视频》</a>，发现这种架构足够秒杀MVP、MVVM，虽然之前的Google I/O大会中也介绍过，但是这次推出是稳定版，而且是可以投入到生产中去。于是就顺着这篇去官网看了使用文档——<a href="https://developer.android.google.cn/topic/libraries/architecture/guide.html" target="_blank" rel="external">《Guide to App Architecture》</a>。为了能够更好的理解架构组件的原理，准备先从Lifecycle入手，一步步去理解。</p>
</blockquote>
<h2 id="为什么需要Lifecycle组件"><a href="#为什么需要Lifecycle组件" class="headerlink" title="为什么需要Lifecycle组件"></a>为什么需要Lifecycle组件</h2><p>&emsp;Lifecycle组件包括LifecycleOwner、LifecycleObserver。为什么需要Lifecycle组件？一项新的技术的提出肯定是为了解决痛点问题，如果使用过MVP模式的话，有个问题：Presenter感知Activity或者Fragment的生命周期？你可能会这样做，Presenter中定义多个和Activity或者Fragment相应的生命周期方法，然后在Activity或者Fragment中调用Presenter中定义的方法。比如下面的这个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Main Presenter</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainPresenter</span> <span class="keyword">implements</span> <span class="title">IPresenter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainPresenter</span><span class="params">(Context context)</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPresenter</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MainActivity"</span>;</div><div class="line">    <span class="keyword">private</span> IPresenter mPresenter;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        Log.d(TAG, <span class="string">"onCreate: "</span>);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mPresenter = <span class="keyword">new</span> MainPresenter(<span class="keyword">this</span>);</div><div class="line">        mPresenter.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStart();</div><div class="line">        Log.d(TAG, <span class="string">"onStart: "</span>);</div><div class="line">        mPresenter.onStart();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line">        Log.d(TAG, <span class="string">"onResume: "</span>);</div><div class="line">        mPresenter.onResume();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onPause();</div><div class="line">        Log.d(TAG, <span class="string">"onPause: "</span>);</div><div class="line">        mPresenter.onPause();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStop();</div><div class="line">        Log.d(TAG, <span class="string">"onStop: "</span>);</div><div class="line">        mPresenter.onStop();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        Log.d(TAG, <span class="string">"onDestroy: "</span>);</div><div class="line">        mPresenter.onDestroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;上面的例子很容易理解，IPresenter中定义和生命周期相关的几个方法，然后在MainActivity中调用对应的方法。这样做会有个问题：在MainActivity中的每个生命周期方法中都要调用一次IPresenter中的接口，对于爱偷懒的程序员来说，这是不能接受的，所以Lifecycle组件就诞生了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainPresenter</span> <span class="keyword">implements</span> <span class="title">IPresenter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MainPresenter"</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainPresenter</span><span class="params">(Context context)</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onCreate: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStart: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onResume: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onPause: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStop: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onDestroy: "</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPresenter</span> <span class="keyword">extends</span> <span class="title">DefaultLifecycleObserver</span></span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MainActivity"</span>;</div><div class="line">    <span class="keyword">private</span> IPresenter mPresenter;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        Log.d(TAG, <span class="string">"onCreate: "</span>);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mPresenter = <span class="keyword">new</span> MainPresenter(<span class="keyword">this</span>);</div><div class="line">        getLifecycle().addObserver(mPresenter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStart();</div><div class="line">        Log.d(TAG, <span class="string">"onStart: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line">        Log.d(TAG, <span class="string">"onResume: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onPause();</div><div class="line">        Log.d(TAG, <span class="string">"onPause: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStop();</div><div class="line">        Log.d(TAG, <span class="string">"onStop: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        Log.d(TAG, <span class="string">"onDestroy: "</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;代码也很简单，IPrestener接口继承DefaultLifecycleObserver接口，然后MainPresenter实现IPresenter接口，在MainPresenter中，我把DefaultLifecycleObserver中生命周期的方法全实现了，也可以选择实现其中几个，比如你只关心MainActivity的onCreate() 和onDestroy()，那么你就可以在MainPresenter中实现onCreate()和onDestroy()方法。借助实现DefaultLifecycleObserver接口可以让我们少写很多代码。知道为什么需要Lifecycle组件后，你可能会问了，Lifecycle组件实现的原理是什么？这就是下面我要将的内容了。</p>
<h2 id="Lifecycle组件原理"><a href="#Lifecycle组件原理" class="headerlink" title="Lifecycle组件原理"></a>Lifecycle组件原理</h2><p>&emsp;一般讲到原理，你可能会看到一堆文字的描述，然后就没有看下去的欲望了，能不能来点生动的，比如带点颜色的？好，我懂你，来张高清无码图。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/lifecycle/class_lifecycle.png" alt="class_lifecyle"></p>
<p>&emsp;我们以V4包中的Fragment（AppCompatActivity类似）为例，看下Fragment和LifecycleOwner、LifecycleObserver、Lifecycle之间的类关系图。</p>
<ul>
<li><p>Lifecycle组件成员Lifecycle被定义成了抽象类，LifecycleOwner、LifecycleObserver被定义成了接口；</p>
</li>
<li><p>Fragment实现了LifecycleOwner接口，该只有一个返回Lifecycle对象的方法getLifecyle()；</p>
</li>
<li><p>Fragment中getLifecycle()方法返回的是继承了抽象类Lifecycle的LifecycleRegistry。</p>
</li>
<li><p>LifecycleRegistry中定义嵌套类ObserverWithState，该类持有GenericLifecycleObserver对象，而GenericLifecycleObserver是继承了LifecycleObserver的接口。</p>
<p>​</p>
</li>
</ul>
<p>&emsp;对于Fragment、Lifecycle、LifecycleOwner、LifecycleObserver的关系有了一定了解后，可以看一个更直观的图，也就是下面的时序图：</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/lifecycle/sequency_lifecycle.png" alt="sequency"></p>
<ul>
<li><p>我们在Fragment（AppCompatActivity也一样）中调用getLifecycle()方法得到LifecycleRegistry对象，然后调用addObserver()方法并将实现了LifecycleObserver接口的对象作为参数传进去。这样一个过程就完成了注册监听的过程。</p>
</li>
<li><p>后续就是Fragment生命周期变化时，通知LifecycleObserver的过程：Fragment的performXXX()、onXXX()方法；LifecycleRegistry的handleLifecycleEvent()方法；LifecycleObserver的onXXX()方法。</p>
</li>
<li><p>如果你细心点看上面的时序图，你会发现Fragment中performCreate()、performStart()、performResume()会先调用自身的onXXX()方法，然后再调用LifecycleRegistry的handleLifecycleEvent()方法；而在performPause()、performStop()、performDestroy()中会先LifecycleRegistry的handleLifecycleEvent()方法 ，然后调用自身的onXXX()方法。比如上面的例子中，打印出来的结果也确实符合我们的分析，打印结果如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">12-01 14:12:59.250 1398-1398/com.shymanzhu.architecture D/MainActivity: onCreate: </div><div class="line">12-01 14:12:59.342 1398-1398/com.shymanzhu.architecture D/MainPresenter: onCreate: </div><div class="line">12-01 14:12:59.345 1398-1398/com.shymanzhu.architecture D/MainActivity: onStart: </div><div class="line">12-01 14:12:59.345 1398-1398/com.shymanzhu.architecture D/MainPresenter: onStart: </div><div class="line">12-01 14:12:59.346 1398-1398/com.shymanzhu.architecture D/MainActivity: onResume: </div><div class="line">12-01 14:12:59.346 1398-1398/com.shymanzhu.architecture D/MainPresenter: onResume: </div><div class="line">12-01 14:12:59.601 1398-1412/com.shymanzhu.architecture D/OpenGLRenderer: Use EGL_SWAP_BEHAVIOR_PRESERVED: true</div><div class="line">12-01 14:12:59.609 1398-1398/com.shymanzhu.architecture I/imx6.gralloc: open gpu gralloc module!</div><div class="line">12-01 14:12:59.847 1398-1412/com.shymanzhu.architecture I/OpenGLRenderer: Initialized EGL, version 1.4</div><div class="line">12-01 14:13:27.348 1398-1398/com.shymanzhu.architecture D/MainPresenter: onPause: </div><div class="line">12-01 14:13:27.349 1398-1398/com.shymanzhu.architecture D/MainActivity: onPause: </div><div class="line">12-01 14:13:28.265 1398-1398/com.shymanzhu.architecture D/MainPresenter: onStop: </div><div class="line">12-01 14:13:28.266 1398-1398/com.shymanzhu.architecture D/MainActivity: onStop: </div><div class="line">12-01 14:13:28.267 1398-1398/com.shymanzhu.architecture D/MainPresenter: onDestroy: </div><div class="line">12-01 14:13:28.267 1398-1398/com.shymanzhu.architecture D/MainActivity: onDestroy:</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<p>&emsp;到现在为止，是不是觉得对大体的框架和流程更加清楚了呢，其实这个Lifecycle组件就是一套设计模式中观察者模式的例子。按道理说，到这里也差不多结束了，具体的细节就是去跟源码了（既然这么说了，肯定有“但是”，机智如你），但是我觉得还是有必要将一些细节说明下。</p>
<h2 id="部分细节"><a href="#部分细节" class="headerlink" title="部分细节"></a>部分细节</h2><p>&emsp; LifecycleOwner、LifecycleObserver、Lifecycle的定义都很简洁，就没必要列举出来了，我们从流程图可以看出来，我们要做的内容主要是实现LifecycleObserver接口，然后通过实现了LifecycleOwner接口的对象进行注册，以监听其生命周期，后续就是坐等通知了。</p>
<h3 id="实现LifecycleObserver接口"><a href="#实现LifecycleObserver接口" class="headerlink" title="实现LifecycleObserver接口"></a>实现LifecycleObserver接口</h3><p>&emsp;从上面的类关系图，我们可以看到有三个接口GenericLifecycleObserver、FullLifecycleObserver、DefaultLifecycleObserver都直接或者间接继承了LifecycleObserver。然而GenericLifecycleObserver是隐藏的，我们用不了。那我们该怎么实现LifecycleObserver接口呢，有两种方式：</p>
<ul>
<li>实现DefaultLifecycleObserver接口，然后重写里面生命周期方法；</li>
<li>直接实现LifecycleObserver接口，然后通过注解的方式来接收生命周期的变化；</li>
</ul>
<p>对于这两种形式，Lifecycle.java文档中是建议使用第一种方式，因为文档中说明了，<strong>随着Java8成为主流，注解的方式会被弃用。</strong></p>
<h3 id="添加观察者"><a href="#添加观察者" class="headerlink" title="添加观察者"></a>添加观察者</h3><p>&emsp;实现LifecycleOwner没什么好说的，我们直接看添加观察者（ addObserver() ），LifecycleRegistry实现了Lifecycle接口，addObserver()实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(@NonNull LifecycleObserver observer)</span> </span>&#123;</div><div class="line">    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</div><div class="line">    ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</div><div class="line">    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</div><div class="line">    <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// it is null we should be destroyed. Fallback quickly</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> isReentrance = mAddingObserverCounter != <span class="number">0</span> || mHandlingEvent;</div><div class="line">    State targetState = calculateTargetState(observer);</div><div class="line">    mAddingObserverCounter++;</div><div class="line">    <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></div><div class="line">            &amp;&amp; mObserverMap.contains(observer))) &#123;</div><div class="line">        pushParentState(statefulObserver.mState);</div><div class="line">        statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</div><div class="line">        popParentState();</div><div class="line">        <span class="comment">// mState / subling may have been changed recalculate</span></div><div class="line">        targetState = calculateTargetState(observer);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</div><div class="line">        <span class="comment">// we do sync only on the top level.</span></div><div class="line">        sync();</div><div class="line">    &#125;</div><div class="line">    mAddingObserverCounter--;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在该方法中主要关注一点：</p>
<ul>
<li>根据observer和initialState构造ObserverWithState对象statefulObserver，然后将该对象存入mObserverMap，可以简单的把它理解成用来保存观察者的Map。</li>
</ul>
<h3 id="坐等通知"><a href="#坐等通知" class="headerlink" title="坐等通知"></a>坐等通知</h3><p>&emsp; 添加观察者后，那观察者接下来就是坐等通知了。从上面的时序图中，我们看到Fragment是通过LifecycleRegistry.handleLifecycleEvent()方法通知LifecycleRegistry其生命周期的，那我们看下LifecycleRegistry的handleLifecycleEvent()相关的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(@NonNull Lifecycle.Event event)</span> </span>&#123;</div><div class="line">        State next = getStateAfter(event);<span class="comment">//计算下一个生命周期状态</span></div><div class="line">        moveToState(next);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(State next)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mState == next) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mState = next;</div><div class="line">        <span class="keyword">if</span> (mHandlingEvent || mAddingObserverCounter != <span class="number">0</span>) &#123;</div><div class="line">            mNewEventOccurred = <span class="keyword">true</span>;</div><div class="line">            <span class="comment">// we will figure out what to do on upper level.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mHandlingEvent = <span class="keyword">true</span>;</div><div class="line">        sync(); <span class="comment">//看下sync()方法的具体实现</span></div><div class="line">        mHandlingEvent = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</div><div class="line">        LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</div><div class="line">        <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</div><div class="line">            Log.w(LOG_TAG, <span class="string">"LifecycleOwner is garbage collected, you shouldn't try dispatch "</span></div><div class="line">                    + <span class="string">"new events from it."</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (!isSynced()) &#123;</div><div class="line">            mNewEventOccurred = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// no need to check eldest for nullability, because isSynced does it for us.</span></div><div class="line">            <span class="comment">//比较当前的生命周期和Map中第一个的观察者的生命周期，下面的另一个if语句类似。</span></div><div class="line">            <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</div><div class="line">                backwardPass(lifecycleOwner);</div><div class="line">            &#125;</div><div class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</div><div class="line">            <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</div><div class="line">                forwardPass(lifecycleOwner);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mNewEventOccurred = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//看下forwardPass()方法</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</div><div class="line">        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =</div><div class="line">                mObserverMap.iteratorWithAdditions();</div><div class="line">        <span class="keyword">while</span> (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</div><div class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();</div><div class="line">            ObserverWithState observer = entry.getValue();</div><div class="line">            <span class="keyword">while</span> ((observer.mState.compareTo(mState) &lt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</div><div class="line">                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</div><div class="line">                pushParentState(observer.mState);</div><div class="line">                observer.dispatchEvent(lifecycleOwner, upEvent(observer.mState));</div><div class="line">                popParentState();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</div><div class="line">        State mState;</div><div class="line">        GenericLifecycleObserver mLifecycleObserver;</div><div class="line"></div><div class="line">        ObserverWithState(LifecycleObserver observer, State initialState) &#123;</div><div class="line">            mLifecycleObserver = Lifecycling.getCallback(observer);</div><div class="line">            mState = initialState;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</div><div class="line">            State newState = getStateAfter(event);</div><div class="line">            mState = min(mState, newState);</div><div class="line">            mLifecycleObserver.onStateChanged(owner, event); <span class="comment">//通知观察者生命周期变化。</span></div><div class="line">            mState = newState;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码中大体的细节就是这样子，当然更细的内容只能通过你自己去了解了，建议明白Lifecycle组件的框架和结构后，再去看它实现的细节，而不是一上来就深究代码，那让会让你只见树木不见森林。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/02/Android 架构组件（一）——Lifecycle-Aware Components/" data-id="cjbu74ywt000257vgdmxrrlei" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lifecycle/">Lifecycle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java两种创建线程方式原理解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/11/Java两种创建线程方式原理解析/" class="article-date">
  <time datetime="2017-11-11T11:45:01.000Z" itemprop="datePublished">2017-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/11/Java两种创建线程方式原理解析/">Java两种创建线程方式原理解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>首先，想这样一个问题：在Java中创建并执行线程任务的方式有哪几种？</p>
</blockquote>
<p>&emsp; 回忆下，你应该很快就能想起来我们在Java中创建线程的方式有两种：</p>
<ul>
<li>继承Thread类并重写run()方法，要执行的任务写在run()方法中，然后new 出该类的对象，并调用其start()方法。</li>
<li>实现Runnable接口，并重写其run()方法，要执行的任务写在run()方法中，然后将实例化的Runnable对象以参数的形式传给Thread对象，然后调用Thread.start()方法。</li>
</ul>
<p>&emsp; 下面就是两种创建并启动线程的两种写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        <span class="keyword">new</span> SubThread().start();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> ImplRunnable()).start();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 实现Runnable接口</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImplRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"implements Runnable "</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 继承Thread类</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.run();</div><div class="line">            System.out.println(<span class="string">"class extends Thread"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p> 在知道两种创建线程的方法后，那么就要想想，为什么这两种方式都是可以创建线程呢？</p>
<p>首先，看图说话，先看下Thread启动的序列图</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/thread/sequency_thread.png" alt="sequency_thread"></p>
<ul>
<li>在主线程中通过调用子线程的start()方法启动子线程；</li>
<li>Java虚拟机会调用子线程的run()方法，在子线程的run()方法中判断Runnable对象不为空时，调用Runnable的run()方法。</li>
</ul>
<p>整体的流程很简单，下面我们通过源码来看具体的实现。</p>
<p>我们知道启动线程是调用了Thread.start()方法，那么我们就从start()方法开始，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Causes this thread to begin execution; the Java Virtual Machine</div><div class="line"> * calls the &lt;code&gt;run&lt;/code&gt; method of this thread.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The result is that two threads are running concurrently: the</div><div class="line"> * current thread (which returns from the call to the</div><div class="line"> * &lt;code&gt;start&lt;/code&gt; method) and the other thread (which executes its</div><div class="line"> * &lt;code&gt;run&lt;/code&gt; method).</div><div class="line"> * &lt;p&gt;</div><div class="line"> * It is never legal to start a thread more than once.</div><div class="line"> * In particular, a thread may not be restarted once it has completed</div><div class="line"> * execution.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@exception</span>  IllegalThreadStateException  if the thread was already</div><div class="line"> *               started.</div><div class="line"> * <span class="doctag">@see</span>        #run()</div><div class="line"> * <span class="doctag">@see</span>        #stop()</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This method is not invoked for the main method thread or "system"</div><div class="line">     * group threads created/set up by the VM. Any new functionality added</div><div class="line">     * to this method in the future may have to also be added to the VM.</div><div class="line">     *</div><div class="line">     * A zero status value corresponds to state "NEW".</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line"></div><div class="line">    <span class="comment">/* Notify the group that this thread is about to be started</span></div><div class="line">     * so that it can be added to the group's list of threads</div><div class="line">     * and the group's unstarted count can be decremented. */</div><div class="line">    group.add(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        start0(); <span class="comment">//native 方法，真正start线程实现</span></div><div class="line">        started = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!started) &#123;</div><div class="line">                group.threadStartFailed(<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</div><div class="line">            <span class="comment">/* do nothing. If start0 threw a Throwable then</span></div><div class="line">              it will be passed up the call stack */</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>start()方法体中的内容，我们不需要关心，主要看方法的说明，里面有提到JVM会调用Thread的run()方法。那么我们接着看run()方法的内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * If this thread was constructed using a separate</div><div class="line"> * &lt;code&gt;Runnable&lt;/code&gt; run object, then that</div><div class="line"> * &lt;code&gt;Runnable&lt;/code&gt; object's &lt;code&gt;run&lt;/code&gt; method is called;</div><div class="line"> * otherwise, this method does nothing and returns.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * Subclasses of &lt;code&gt;Thread&lt;/code&gt; should override this method.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span>     #start()</div><div class="line"> * <span class="doctag">@see</span>     #stop()</div><div class="line"> * <span class="doctag">@see</span>     #Thread(ThreadGroup, Runnable, String)</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">        target.run();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重点还是看方法的说明：</p>
<ul>
<li>如果在Thread构造方法中传入了Runnable对象，那么会调用Runnable的run()方法；</li>
<li>如果是继承Thread类，那么子类应该重写run()方法。</li>
</ul>
<p>我们可以从Thread(Runnable target)构造方法入手，看下target对象是怎么初始化的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">(Runnable target)</span> </span>&#123;</div><div class="line">    init(<span class="keyword">null</span>, target, <span class="string">"Thread-"</span> + nextThreadNum(), <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Initializes a Thread with the current AccessControlContext.</div><div class="line"> * <span class="doctag">@see</span> #init(ThreadGroup,Runnable,String,long,AccessControlContext)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></div><div class="line">                  <span class="keyword">long</span> stackSize) &#123;</div><div class="line">    init(g, target, name, stackSize, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></div><div class="line">                  <span class="keyword">long</span> stackSize, AccessControlContext acc) &#123;</div><div class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name cannot be null"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.name = name.toCharArray();</div><div class="line"></div><div class="line">    Thread parent = currentThread();</div><div class="line">    SecurityManager security = System.getSecurityManager();</div><div class="line">    <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">/* Determine if it's an applet or not */</span></div><div class="line"></div><div class="line">        <span class="comment">/* If there is a security manager, ask the security manager</span></div><div class="line">           what to do. */</div><div class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</div><div class="line">            g = security.getThreadGroup();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* If the security doesn't have a strong opinion of the matter</span></div><div class="line">           use the parent thread group. */</div><div class="line">        <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</div><div class="line">            g = parent.getThreadGroup();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* checkAccess regardless of whether or not threadgroup is</span></div><div class="line">       explicitly passed in. */</div><div class="line">    g.checkAccess();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Do we have the required permissions?</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (isCCLOverridden(getClass())) &#123;</div><div class="line">            security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    g.addUnstarted();</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.group = g;</div><div class="line">    <span class="keyword">this</span>.daemon = parent.isDaemon();</div><div class="line">    <span class="keyword">this</span>.priority = parent.getPriority();</div><div class="line">    <span class="keyword">if</span> (security == <span class="keyword">null</span> || isCCLOverridden(parent.getClass()))</div><div class="line">        <span class="keyword">this</span>.contextClassLoader = parent.getContextClassLoader();</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">this</span>.contextClassLoader = parent.contextClassLoader;</div><div class="line">    <span class="keyword">this</span>.inheritedAccessControlContext =</div><div class="line">            acc != <span class="keyword">null</span> ? acc : AccessController.getContext();</div><div class="line">    <span class="keyword">this</span>.target = target;  <span class="comment">// target对象在此赋值</span></div><div class="line">    setPriority(priority);</div><div class="line">    <span class="keyword">if</span> (parent.inheritableThreadLocals != <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">this</span>.inheritableThreadLocals =</div><div class="line">            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</div><div class="line">    <span class="comment">/* Stash the specified stack size in case the VM cares */</span></div><div class="line">    <span class="keyword">this</span>.stackSize = stackSize;</div><div class="line"></div><div class="line">    <span class="comment">/* Set thread ID */</span></div><div class="line">    tid = nextThreadID();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp; 在了解两种创建并启动线程的两种方式后，可以去看看Thread的类，类说明里面有提到：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">* There are two ways to create a new thread of execution. One is to</div><div class="line">* declare a class to be a subclass of &lt;code&gt;Thread&lt;/code&gt;. This</div><div class="line">* subclass should override the &lt;code&gt;run&lt;/code&gt; method of class</div><div class="line">* &lt;code&gt;Thread&lt;/code&gt;.</div></pre></td></tr></table></figure>
<p>其实，在继承Thread后也可以完全不用重写run()方法，照样可以执行线程的内容。只不过是要修改过下子类的构造方法，比如把开头的例子改成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        <span class="keyword">new</span> SubThread(<span class="keyword">new</span> ImplRunnable()).start();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> ImplRunnable()).start();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 实现Runnable接口</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImplRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"implements Runnable "</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 继承Thread类</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SubThread</span><span class="params">(Runnable runnable)</span></span>&#123;</div><div class="line">            <span class="keyword">super</span>(runnable);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为什么这样也可以，相信看完这篇文件你肯定能明白的。至于这样方式是否优雅，反正我是不太喜欢的，只是动点逆向思维，just for fun…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/11/Java两种创建线程方式原理解析/" data-id="cjbu74yxe000957vg2lu8ihyr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Thread/">Thread</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-如何正确的给ViewGroup设置OnClickListener" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/23/如何正确的给ViewGroup设置OnClickListener/" class="article-date">
  <time datetime="2017-07-22T22:37:01.000Z" itemprop="datePublished">2017-07-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/23/如何正确的给ViewGroup设置OnClickListener/">如何正确的给ViewGroup设置OnClickListener</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>在Android的日常开发中，我们总会碰到要给某个LinearLayout、RelativeLayout等设置OnClickListener，以便达到点击其子view能够触发设置的OnClickListener。但是当我们点击子view的时候，对应的Listener并没有触发到，这是为什么呢，接下来我们将结合例子从源码角度去解释它。</p>
</blockquote>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>  我们从一个简单的需求出发：有一个Button和一个TextView，当他们被点击后都要响应相同的事件。我们可以同时设置Button和TextView的点击监听，但是这样代码量就比较大了。作为爱偷懒的程序员，又怎么愿意这么干呢，反正我的内心是拒绝的。我们容易想到的方法就是给Button和TextView所在的ViewGroup设置点击事件。可能我们会这样做：</p>
<ul>
<li>假如布局文件我们是这样写的：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/layout_group"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"100dp"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Button1"</span>/&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@string/test"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"30sp"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"30dp"</span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/tv"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>代码内容也很简单，信手捏来</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zhuzp.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.LinearLayout;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by zhuzp on 2016/9/29.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"TestActivity"</span>;</div><div class="line">    <span class="keyword">private</span> View layoutView;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState); </div><div class="line">        setContentView(R.layout.test_activity);</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span></span>&#123;</div><div class="line">        layoutView = findViewById(R.id.layout_group);</div><div class="line">        layoutView.setOnClickListener(mClickListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mClickListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            Log.d(TAG,<span class="string">"onClick...."</span>+ v.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在代码中给Button和TextView所在的LinearLayout中设置了点击事件监听。Easy，是不是？然后我们看下运行的结果吧。</p>
<p> 点击Button怎么没有打印出来，但是点击TextView的时候有打印，打印的结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">01-02 14:19:32.220 5891-5891/com.zhuzp.test D/TestActivity: onClick....com.zhuzp.test.widget.MyLinearLayout&#123;41907c58 V.E...C. ...P.... 64,16-339,64 #7f0c0063 app:id/layout_group&#125;</div></pre></td></tr></table></figure>
<p>不和常理啊，按道理应该都有打印出来的，对不对？嗯，有可能你知道问题出在哪，下面我先给出几种解决方法，然后再解释为什么这几种方法是可行的。</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><h4 id="1-重写LinearLayout的setOnClickListener-View-OnClickListener-listener-方法，通过给每个子view设置点击事件。"><a href="#1-重写LinearLayout的setOnClickListener-View-OnClickListener-listener-方法，通过给每个子view设置点击事件。" class="headerlink" title="1,重写LinearLayout的setOnClickListener(View.OnClickListener listener)方法，通过给每个子view设置点击事件。"></a>1,重写LinearLayout的setOnClickListener(View.OnClickListener listener)方法，通过给每个子view设置点击事件。</h4><p>比如我们定义个MyLinearLayout，继承LinerLayout。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zhuzp.test.widget;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.util.AttributeSet;</div><div class="line"><span class="keyword">import</span> android.view.MotionEvent;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.Button;</div><div class="line"><span class="keyword">import</span> android.widget.LinearLayout;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by zhuzp on 2016/9/28.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLinearLayout</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyLinearLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(OnClickListener l)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.setOnClickListener(l);</div><div class="line">        <span class="keyword">int</span> N = getChildCount();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)&#123;</div><div class="line">            View view = getChildAt(i);</div><div class="line">            view.setOnClickListener(l);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  然后修改布局文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.zhuzp.test.widget.MyLinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/layout_group"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/btn"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"100dp"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Button1"</span>/&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Text"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"30sp"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"30dp"</span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/tv"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">com.zhuzp.test.widget.MyLinearLayout</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>  然后我们看下运行的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">10-08 12:00:12.765 6247-62471/com.zhuzp.test D/TestActivity: onClick....android.widget.Button&#123;4190a4a0 VFED..C. ...P.... 100,0-187,48 #7f0c0064 app:id/btn&#125;</div><div class="line">10-08 12:00:12.765 6247-6247/com.zhuzp.test D/TestActivity: onClick....android.widget.TextView&#123;41911480 V.ED..C. ...P.... 217,3-275,44 #7f0c0066 app:id/tv&#125;</div></pre></td></tr></table></figure>
<p>从结果来看，看样子我们是已经解决了问题，OK，这就是第一种方法。</p>
<h4 id="2-重写LinearLayout的onInterceptTouchEvent-方法，返回true。"><a href="#2-重写LinearLayout的onInterceptTouchEvent-方法，返回true。" class="headerlink" title="2,重写LinearLayout的onInterceptTouchEvent()方法，返回true。"></a>2,重写LinearLayout的onInterceptTouchEvent()方法，返回true。</h4><p> 代码就不重复了，和方法1中基本类似。结果每次点击Button或者TextView时,打印信息为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">10-08 12:02:12.765 6247-6247/com.zhuzp.test D/TestActivity: onClick....android.widget.LinearLayout&#123;419cd1b0 V.E...C. ...P.... 16,16-291,64 #7f0c0063 app:id/layout_group&#125;</div><div class="line">10-08 12:02:14.355 6247-6247/com.zhuzp.test D/TestActivity: onClick....android.widget.LinearLayout&#123;419cd1b0 V.E...C. ...P.... 16,16-291,64 #7f0c0063 app:id/layout_group&#125;</div></pre></td></tr></table></figure>
<p>从打印信息来看我们的问题好像也得到了解决，但是如果你的Button 和TextView设置了背景selector,是没有相应的效果的。</p>
<h4 id="3，增加Button-的android-clickable-“false”"><a href="#3，增加Button-的android-clickable-“false”" class="headerlink" title="3，增加Button 的android:clickable=“false”."></a>3，增加Button 的android:clickable=“false”.</h4><p>   布局文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/layout_group"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"100dp"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:clickable</span>=<span class="string">"false"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Button1"</span>/&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Text"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"30sp"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"30dp"</span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/tv"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>   然后，我们看下点击Button和TextView打印的log 的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">10-08 12:05:12.765 6247-6247/com.zhuzp.test D/TestActivity: onClick....android.widget.LinearLayout&#123;419cd1b0 V.E...C. ...P.... 16,16-291,64 #7f0c0063 app:id/layout_group&#125;</div><div class="line">10-08 12:05:14.355 6247-6247/com.zhuzp.test D/TestActivity: onClick....android.widget.LinearLayout&#123;419cd1b0 V.E...C. ...P.... 16,16-291,64 #7f0c0063 app:id/layout_group&#125;</div></pre></td></tr></table></figure>
<p>从log中我们可以看到，当我们点击Button和TextView的时候，实际上响应点击的是他们所在的ViewGroup——LinearLayout。</p>
<p><strong><em> 对比两种方式，很明显第三种方法来得简单</em></strong></p>
<h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>​    首先要明确：</p>
<ul>
<li><strong>当我们给View(ViewGroup)设置了View.OnClickListener后，View (ViewGroup)是否响应点击事件是在其onTouchEvent(MotionEvent event)判断的。</strong></li>
<li><strong>View事件分发的流程图，这里我们只关心ViewGroup和View这一块</strong></li>
</ul>
<p> <img src="http://img.blog.csdn.net/20161105100847306" alt="image"></p>
<p> 明确上面两点后，解下来就比较容易理解了。</p>
<p><strong>方法1其实是一种比较hack的方法，为每个子view设置了监听，最终由每个子view去响应点击事件。方法二，结合上面的图就很好理解了，子view根本没有收到touch 事件，touch事件由ViewGroup的onTouchEvent()方法处理，在onTouchEvent()方法中会去处理点击事件。方法3为什么可以呢，从上面的图你可能已经猜到在Button设置了android:clickable=”false”属性之后，Button 的onTouchEvent()应该是返回了false。究竟是否是这样的呢，接下来我们一起结合源码调试下，你没听错，就是调试。</strong></p>
<h4 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h4><p> 知道上面的结论后，我们开始结合代码验证下：</p>
<ul>
<li>创建一个类继承Button，方法比如命名为MyButton，重写onTouchEvent()。</li>
<li>在布局文件中引用创建的MyButton。</li>
</ul>
<p>MyButton代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zhuzp.test.widget;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.util.AttributeSet;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.MotionEvent;</div><div class="line"><span class="keyword">import</span> android.widget.Button;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by zhuzp on 2016/9/29.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyButton</span> <span class="keyword">extends</span> <span class="title">Button</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MyButton"</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyButton</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> result = <span class="keyword">super</span>.onTouchEvent(event);</div><div class="line">        Log.d(TAG,<span class="string">"onTouchEvent = "</span> + result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>布局文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"@dimen/activity_vertical_margin"</span></div><div class="line">    <span class="attr">android:paddingLeft</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingRight</span>=<span class="string">"@dimen/activity_horizontal_margin"</span></div><div class="line">    <span class="attr">android:paddingTop</span>=<span class="string">"@dimen/activity_vertical_margin"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/layout_group"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">com.zhuzp.test.widget.MyButton</span></span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"100dp"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Button1"</span>/&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"Text"</span></div><div class="line">            <span class="attr">android:textSize</span>=<span class="string">"30sp"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"30dp"</span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/tv"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>最后Activity代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zhuzp.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.LinearLayout;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by zhuzp on 2016/9/29.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"TestActivity"</span>;</div><div class="line">    <span class="keyword">private</span> View layoutView;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState); </div><div class="line">        setContentView(R.layout.test_activity);</div><div class="line">        initView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span></span>&#123;</div><div class="line">        layoutView = findViewById(R.id.layout_group);</div><div class="line">        layoutView.setOnClickListener(mClickListener);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View.OnClickListener mClickListener = <span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">            Log.d(TAG,<span class="string">"onClick...."</span>+ v.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 整个代码内容都很简单，为什么我们要定义一个继承Button的类，这里主要是为了通过Android Studio结合源码调试。我们在MyButton的”boolean result = super.onTouchEvent(event);”前面打个断点，然后开始debug调试。</p>
<ul>
<li>在你的Android设备上点击button</li>
</ul>
<p><img src="http://img.blog.csdn.net/20161105100942339" alt="image"></p>
<p>如上图，然后按”F7”进入super.onTouchEvent()，如果你有安装多个sdk版本，选择你Android设备对应的版本,比如我的设备是Android4.4，那么我就选择API 19。</p>
<p><img src="http://img.blog.csdn.net/20161105101019559" alt="image"></p>
<ul>
<li>选择对应的的版本后，进入到TextView(Button继承自TextView)的onTouchEvent()方法，</li>
</ul>
<p><img src="http://img.blog.csdn.net/20161105101048722" alt="image"></p>
<p>按“F8”到下一步，然后到“final boolean superResult = super.onTouchEvent(event);”,按“F7”进入View的onTouchEvent()方法。</p>
<p><img src="http://img.blog.csdn.net/20161105101115326" alt="image"></p>
<p>然后一直“F8”，然后走到”if (((viewFlags &amp; CLICKABLE) == CLICKABLE ||(viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE))”中，你会发现<strong>进入了这个if语句后，View的onTouchEvent()方法返回的都是true，如果没进if语句，返回的就是false。</strong></p>
<p>当从View的onTouchEvent()中返回后，回到TextView.onTouchEvent()方法，然后一步步走下去，你会发现最终TextView.onTouchEvent()返回的就是super.onTouchEvent()的返回值。<strong>所以要想上面的例子中的LinearLayout响应点击事件，要设置Button的android:clickable=”false”。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/23/如何正确的给ViewGroup设置OnClickListener/" data-id="cjbu74yxh000b57vg3sqlca1a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android Studio 如何像Eclipse一样配置User Library" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/10/Android Studio 如何像Eclipse一样配置User Library/" class="article-date">
  <time datetime="2017-07-09T20:27:01.000Z" itemprop="datePublished">2017-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/10/Android Studio 如何像Eclipse一样配置User Library/">Android Studio 如何像Eclipse一样配置User Library</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>熟悉了用Eclipse开发Android应用，转用Android Studio的时候总会碰到一些在Eclipse中很好用的功能，在Android Studio中找不到应用的功能，比如导入第三方jar包。</p>
</blockquote>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>​        熟悉Eclipse的都知道，当我们要导入第三方jar包，我们一般<strong>不会</strong>将jar包放在项目的libs文件夹下，特别是可能多个项目同时会用到同一个jar包时，一般我们都是在User Libraries中new 一个User Library，然后将为其配置特定的jar包。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/android_studio_jarlib_like_eclipse/eclipse_user_lib.png" alt="image"></p>
<p>这样，我们后面要使用的话，就可以直接引用了,像下面一样：</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/android_studio_jarlib_like_eclipse/eclipse_user_lib.png" alt="image"></p>
<p>这种方式可以省去每次都copy到每个项目的libs文件夹中。此外，当这个jar有更新时，也不用copy到libs文件夹中更新。然而，我们在Android Studio中导入第三方jar包时，一般仍然是采用copy到module中libs文件夹中的方式，这种方式的缺点可想而知。那么问题来了，在Android Studio能不能像Eclipse中那样，做到不用多次copy，一处更新，处处更新的效果呢？答案是肯定的，下面我们就看下具体的方法。</p>
<h3 id="Android-Studio中的实现"><a href="#Android-Studio中的实现" class="headerlink" title="Android Studio中的实现"></a>Android Studio中的实现</h3><p>&emsp;在Android Studio中实现引用特定位置的jar的方式其实和Eclipse中的原理类似。我们看下具体的步骤，就会理解他们的相似之处。</p>
<ul>
<li><p>在你的Project下面的buid.gradle文件中的最外层定义如下内容：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ext &#123;</div><div class="line">    kernelServicePath=<span class="string">'E:\\shymanzhu\\workspace\\jarlibs\\szx_kernel_service_lib.jar'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在ext命名空间中定义jar包位置属性kernelServicePath,并指定jar包的绝对路径。有关于”ext”命名空间的更多内容照<a href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html" target="_blank" rel="external">Project</a>中关于Extra 属性的解释。</p>
</li>
<li><p>在你的Project的ext命名空间中定义好后，然后就可以在你任意需要引用的module中引用了。比如想在Module A中引用刚才的jar包，那么在Module A中的build.gradle的“dependence”命名空间中文加入如下内容：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile files(rootProject.ext.kernelServicePath)</div></pre></td></tr></table></figure>
<p>这样就实现和Eclipse中一样的效果了。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/10/Android Studio 如何像Eclipse一样配置User Library/" data-id="cjbu74yx7000657vgdmlo8qwq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-Studio/">Android Studio</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-自定义SpinnerPreference" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/29/自定义SpinnerPreference/" class="article-date">
  <time datetime="2017-06-28T23:43:30.000Z" itemprop="datePublished">2017-06-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/29/自定义SpinnerPreference/">自定义SpinnerPreference</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;我们知道Android提供了CheckBoxPreference, EditTextPreference, ListPreference, MultiSelectListPreference, SwitchPreference等控件。但这些控件不能满足日常有些需求，比如客户要这种效果。<br><img src="http://oq6yfhskd.bkt.clouddn.com/blog/spinner_preference/spinner_pref.png" alt="image"></p>
<p>这种效果，当然我们可以用Textview和Spinner嵌套在LinearLayout中实现，但可以扩展性不好，如果有多项话，Layout文件会显得很臃肿。所以我们会想到采用preference来实现。不过在Android提供的Preference中并没有类似于效果图中的这种带有Spinner的，于是就有了这篇博客。</p>
<h3 id="一，整体方法"><a href="#一，整体方法" class="headerlink" title="一，整体方法"></a>一，整体方法</h3><p>实现带Spinner的Preference我们分为以下几个步骤：</p>
<ol>
<li>将Spinner作为widget加进preference。</li>
<li>定义Spinner对应的显示的数据以及显示数据的对应值等属性，这个类似于ListPreference的entries和entrieValues。</li>
<li>设定Spinner数据改变的接口</li>
<li>在xml文件中引用</li>
</ol>
<h3 id="二，具体实现"><a href="#二，具体实现" class="headerlink" title="二，具体实现"></a>二，具体实现</h3><p>&emsp; 我们将要实现的preference定义为SpinnerPreference：</p>
<ul>
<li>第一步，我们在SpinnerPreference的构造方法通过<code>setWidgetLayoutResource(R.layout.custom_spinner_preference)</code>方法将Spinner加入到preference中。custom_spinner_preferenced定义如下：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.AppCompatSpinner</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">android:focusableInTouchMode</span>=<span class="string">"true"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/preference_spinner"</span></div><div class="line">    <span class="attr">android:popupBackground</span>=<span class="string">"@drawable/shape_bg_spinner"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@drawable/bg_spinner"</span></div><div class="line">    <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</div></pre></td></tr></table></figure>
<ul>
<li><p>第二步，我们要定义spinner中的数据来源，我们参照ListPreference的方式，在atrrs.xml中定义spinner显示的数据以及显示的显示的数据对应的值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"SpinnerPreference"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"entries"</span> <span class="attr">format</span>=<span class="string">"reference"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"entryValues"</span> <span class="attr">format</span>=<span class="string">"reference"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>第三步，设定spinner数据改变接口。这个主要是在spinner设置的 的OnItemSelectedListener中实现。具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mSpinner.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">        CharSequence value = mEntryValues[position];</div><div class="line">        <span class="keyword">if</span> (!value.equals(mCurrentValue))&#123;</div><div class="line">            mOnChangeListener.onPreferenceChange(SpinnerPreference.<span class="keyword">this</span>,value);</div><div class="line">            mCurrentValue = value;</div><div class="line">            SpinnerPreference.<span class="keyword">this</span>.persistInt(position);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; parent)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>SpinnerPreference 对外提供的数据改变接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnPreferenceChangeListener</span><span class="params">(OnPreferenceChangeListener onPreferenceChangeListener)</span> </span>&#123;</div><div class="line">    mOnChangeListener = onPreferenceChangeListener;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>第四步，在xml中引用。<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">PreferenceScreen</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res/com.szxen.carsetting"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">CheckBoxPreference</span></span></div><div class="line">        <span class="attr">android:key</span>=<span class="string">"key_radar_switch_to_reverse"</span></div><div class="line">        <span class="attr">android:layout</span>=<span class="string">"@layout/custom_preference"</span></div><div class="line">        <span class="attr">android:title</span>=<span class="string">"@string/radar_switch_2_reverse"</span></div><div class="line">        <span class="attr">android:widgetLayout</span>=<span class="string">"@layout/custom_preference_widget_checkbox"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.szxen.carsetting.widget.SpinnerPreference</span></span></div><div class="line">        <span class="attr">app:entries</span>=<span class="string">"@array/camera_entries"</span></div><div class="line">        <span class="attr">app:entryValues</span>=<span class="string">"@array/camera_entries_value"</span></div><div class="line">        <span class="attr">android:key</span>=<span class="string">"key_camera_front"</span></div><div class="line">        <span class="attr">android:layout</span>=<span class="string">"@layout/custom_preference"</span></div><div class="line">        <span class="attr">android:title</span>=<span class="string">"@string/camera_front"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.szxen.carsetting.widget.SpinnerPreference</span></span></div><div class="line">        <span class="attr">app:entries</span>=<span class="string">"@array/back_camera_entries"</span></div><div class="line">        <span class="attr">app:entryValues</span>=<span class="string">"@array/back_camera_entries_value"</span></div><div class="line">        <span class="attr">android:key</span>=<span class="string">"key_camera_back"</span></div><div class="line">        <span class="attr">android:layout</span>=<span class="string">"@layout/custom_preference"</span></div><div class="line">        <span class="attr">android:title</span>=<span class="string">"@string/camera_back"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.szxen.carsetting.widget.SpinnerPreference</span></span></div><div class="line">        <span class="attr">app:entries</span>=<span class="string">"@array/camera_entries"</span></div><div class="line">        <span class="attr">app:entryValues</span>=<span class="string">"@array/camera_entries_value"</span></div><div class="line">        <span class="attr">android:key</span>=<span class="string">"key_camera_left"</span></div><div class="line">        <span class="attr">android:layout</span>=<span class="string">"@layout/custom_preference"</span></div><div class="line">        <span class="attr">android:title</span>=<span class="string">"@string/camera_left"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.szxen.carsetting.widget.SpinnerPreference</span></span></div><div class="line">        <span class="attr">app:entries</span>=<span class="string">"@array/camera_entries"</span></div><div class="line">        <span class="attr">app:entryValues</span>=<span class="string">"@array/camera_entries_value"</span></div><div class="line">        <span class="attr">android:key</span>=<span class="string">"key_camera_right"</span></div><div class="line">        <span class="attr">android:layout</span>=<span class="string">"@layout/custom_preference"</span></div><div class="line">        <span class="attr">android:title</span>=<span class="string">"@string/camera_right"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">PreferenceScreen</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>说明：custom_preference为了改变系统preference默认layout的文件,内容和系统的相差无几，主要是布局。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="comment">&lt;!-- Copyright (C) 2006 The Android Open Source Project</span></div><div class="line"></div><div class="line">     Licensed under the Apache License, Version 2.0 (the "License");</div><div class="line">     you may not use this file except in compliance with the License.</div><div class="line">     You may obtain a copy of the License at</div><div class="line"></div><div class="line">          http://www.apache.org/licenses/LICENSE-2.0</div><div class="line"></div><div class="line">     Unless required by applicable law or agreed to in writing, software</div><div class="line">     distributed under the License is distributed on an "AS IS" BASIS,</div><div class="line">     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div class="line">     See the License for the specific language governing permissions and</div><div class="line">     limitations under the License.</div><div class="line">--&gt;</div><div class="line"></div><div class="line"><span class="comment">&lt;!-- Layout for a Preference in a PreferenceActivity. The</span></div><div class="line">     Preference is able to place a specific widget for its particular</div><div class="line">     type in the "widget_frame" layout. --&gt;</div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span> </span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"@dimen/preference_item_width"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"@dimen/preference_item_height"</span></div><div class="line">    <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></div><div class="line">    <span class="attr">android:paddingEnd</span>=<span class="string">"?android:attr/scrollbarSize"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@drawable/selector_list"</span> &gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+android:id/icon"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_marginStart</span>=<span class="string">"15dip"</span></div><div class="line">        <span class="attr">android:layout_marginEnd</span>=<span class="string">"6dip"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"6dip"</span></div><div class="line">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"6dip"</span></div><div class="line">        <span class="attr">android:layout_weight</span>=<span class="string">"1"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:id</span>=<span class="string">"@+android:id/title"</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:singleLine</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">style</span>=<span class="string">"@style/preferenceTitleStyle"</span></div><div class="line">            <span class="attr">android:ellipsize</span>=<span class="string">"marquee"</span></div><div class="line">            <span class="attr">android:fadingEdge</span>=<span class="string">"horizontal"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:id</span>=<span class="string">"@+android:id/summary"</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_toRightOf</span>=<span class="string">"@android:id/title"</span></div><div class="line">            <span class="attr">android:layout_alignTop</span>=<span class="string">"@android:id/title"</span></div><div class="line">            <span class="attr">android:layout_alignParentRight</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:gravity</span>=<span class="string">"right"</span></div><div class="line">            <span class="attr">style</span>=<span class="string">"@style/preferenceSummaryStyle"</span></div><div class="line">            <span class="attr">android:maxLines</span>=<span class="string">"4"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Preference should place its actual preference widget here. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">android:id</span>=<span class="string">"@+android:id/widget_frame"</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"@dimen/preference_widget_width"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"left|center_vertical"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>最后，附上SpinnerPreference的完整代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.szxen.carsetting.widget;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.content.res.TypedArray;</div><div class="line"><span class="keyword">import</span> android.preference.Preference;</div><div class="line"><span class="keyword">import</span> android.util.AttributeSet;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.KeyEvent;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.view.ViewGroup;</div><div class="line"><span class="keyword">import</span> android.widget.AdapterView;</div><div class="line"><span class="keyword">import</span> android.widget.Spinner;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.szxen.carsetting.R;</div><div class="line"><span class="keyword">import</span> com.szxen.carsetting.utils.PreferenceUtils;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by zhuzp on 2016/9/6.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinnerPreference</span> <span class="keyword">extends</span> <span class="title">Preference</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>,<span class="title">View</span>.<span class="title">OnKeyListener</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SpinnerPreference"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="keyword">private</span> CharSequence[] mEntries;</div><div class="line">    <span class="keyword">private</span> CharSequence[] mEntryValues;</div><div class="line">    <span class="keyword">private</span> CharSequence mCurrentValue = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> Preference.OnPreferenceChangeListener mOnChangeListener;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Spinner mSpinner;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDefaultPosition = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpinnerPreference</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpinnerPreference</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context,attrs);</div><div class="line">        setWidgetLayoutResource(R.layout.custom_spinner_preference);</div><div class="line">        init(context,attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, AttributeSet attrs)</span></span>&#123;</div><div class="line">        mContext = context;</div><div class="line">        TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.SpinnerPreference);</div><div class="line">        mEntries = a.getTextArray(R.styleable.SpinnerPreference_entries);</div><div class="line">        mEntryValues = a.getTextArray(R.styleable.SpinnerPreference_entryValues);</div><div class="line">        a.recycle();</div><div class="line">        mCurrentValue = mEntryValues[getPersistedInt(mDefaultPosition)];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">onCreateView</span><span class="params">(ViewGroup parent)</span> </span>&#123;</div><div class="line">        View view = <span class="keyword">super</span>.onCreateView(parent);</div><div class="line">        view.requestFocus();</div><div class="line">        view.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">//处理按键事件</span></div><div class="line">        view.setOnKeyListener(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBindView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onBindView(view);</div><div class="line">        mSpinner = (Spinner) view.findViewById(R.id.preference_spinner);</div><div class="line">        mSpinner.setAdapter(<span class="keyword">new</span> MySpinnerAdapter(mContext,mEntries));</div><div class="line">        mSpinner.setSelection(getPersistedInt(mDefaultPosition));</div><div class="line">        mSpinner.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">                CharSequence value = mEntryValues[position];</div><div class="line">                <span class="keyword">if</span> (!value.equals(mCurrentValue))&#123;</div><div class="line">                    mOnChangeListener.onPreferenceChange(SpinnerPreference.<span class="keyword">this</span>,value);</div><div class="line">                    mCurrentValue = value;</div><div class="line">                    SpinnerPreference.<span class="keyword">this</span>.persistInt(position);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; parent)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnPreferenceChangeListener</span><span class="params">(OnPreferenceChangeListener onPreferenceChangeListener)</span> </span>&#123;</div><div class="line">        mOnChangeListener = onPreferenceChangeListener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        Log.d(TAG,<span class="string">"onClick....."</span>);</div><div class="line">        mSpinner.performClick();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKey</span><span class="params">(View v, <span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (keyCode)&#123;</div><div class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_DPAD_CENTER:</div><div class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_ENTER:</div><div class="line">                mSpinner.performClick();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/06/29/自定义SpinnerPreference/" data-id="cjbu74yxj000d57vgg3rz1yux" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spinner/">Spinner</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/自定义View/">自定义View</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android APK 瘦身实战（二）——资源文件优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/13/Android APK 瘦身实战（二）——资源文件优化/" class="article-date">
  <time datetime="2017-06-12T21:29:30.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/13/Android APK 瘦身实战（二）——资源文件优化/">Android APK瘦身实战（二）——资源文件优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>在前一篇文章——<a href="http://shymanzhu.com/2017/05/21/Android%20APK%20%E7%98%A6%E8%BA%AB%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94APK%E5%88%86%E6%9E%90/" target="_blank" rel="external">Android APK瘦身实战（一）APK分析</a>中，我们可以知道自己APK的大小构成，在知道APK的大小构成后，我们就可以针对特定的部分瘦身了。</p>
</blockquote>
<h2 id="删除无用资源"><a href="#删除无用资源" class="headerlink" title="删除无用资源"></a>删除无用资源</h2><p>  在APK中，资源文件占用了很大的比重，所以在APK瘦身的时候，首先可以考虑优化，资源文件，删除无用的音视频、图片资源。借助于Android Studio的分析工具，我们可以很方便找到未使用的资源文件。</p>
<p> Analyze&gt;Run Inspection by name(Windows下也可以调用快捷键：Ctrl + Shift + Alt + I)，然后输入 unused resource</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/inspection_choose.png" alt=""></p>
<p>选择你的project或者module</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/inspection_scpoe.png" alt=""></p>
<p>然后在Inspection Results中会看到有哪些无用的资源，比如我们作坊的一个项目inspection结果如下：</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/inspection_result.png" alt=""></p>
<p>在这里你可以发现有哪些是无用的资源，保险起见，你可以一个个查看，然后删除这些无用资源。当然，咱们也可以一次性全部删掉，反正咱们不是有Git 吗，那么选中你的module，右键Refactor &gt;  Remove Unused Resources ，然后选择Refactor。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/remove_all_unused_resources.png" alt=""></p>
<p>完了之后，再次检测时会发现已经没有了未使用的资源文件，但是这个还没有结束，因为还有可能有些未使用的类中引用了资源文件，这个时候，再次检查未使用的声明，</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/inspection_unused_declaration.png" alt=""></p>
<p>这里比较麻烦，需要一个个的去找未使用的类，然后根据具体情况判断是否要删掉他们，删掉后再检查未使用的资源文件。Stack Overflow上面一个关于只检查未使用的类的<a href="https://stackoverflow.com/a/38244028/7234029" target="_blank" rel="external">方法</a>,但是并不凑效。</p>
<h2 id="图片优化"><a href="#图片优化" class="headerlink" title="图片优化"></a>图片优化</h2><p>&emsp; 图片优化是APK瘦身效果最明显的地方，毕竟每个应用中都有不少的图片。图片优化我们可以从以下几个方面来进行：</p>
<h3 id="如何选择图片"><a href="#如何选择图片" class="headerlink" title="如何选择图片"></a>如何选择图片</h3><p>  首先要吐槽下我作坊的UI，每次切图过来，所有的图都是32位深的，然后我就问了，为什么都是32位的，他说不知道。选择位深度的依据是啥，也是同样不知道。敢情切图都是随意蒙的啊，甚至曾静给我一张3M多的48位的背景图（虽然在编译成APK时，studio会将它压缩为24位的图），真想把他拉去打靶。。。。不知道也可以查查嘛，再不济也大概可以看看其他大厂的切图是怎样的，然后基本确定下位深度的选择吧。</p>
<ul>
<li><p>png 8 ，支持256种颜色的索引值表示。png8适合那些颜色比较单一的图像，比如纯色。png8是使用索引值来表示颜色的，并不是采用RGB值来表示，用一个比较直观的例子说明什么是使用索引表示颜色。</p>
<p>有一张32位深的图，使用PS转化成web和设备所用格式（快捷键：Alt + Ctrl + Shift + S）</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/convert_web_device.png" alt=""></p>
<p>1，选择png8，选透明度是指是否透明，不勾选的话就是不透明。</p>
<p>2，鼠标放在绿色区域，</p>
<p>3，然后可以看到该区域的alpha值和16进制颜色值，以及索引。alpha 255表示不透明，索引 1表示鼠标选中的区域的颜色在这张图中所有颜色中的索引。将鼠标放在不同的区域，这些值会变化；从图中可以看出，包括透明区域，有三种颜色，所以索引值有：0、1、2三种。</p>
</li>
<li><p>png 24，8位3通道颜色表示，GRB分表用8bit位表示，不支持透明。在图片颜色比较丰富，而又不需要透明的时候可以考虑用24位png图，但是这个时候很多都会用JPG来替代了，因为毕竟JPG更小啊</p>
</li>
<li><p>png 32，在24位的基础上增加8bit位表示alpha通道，也就是alpha值可以从1到256。</p>
</li>
</ul>
<p>从上面的解释来看，既然png8 和png32 都支持透明，那该如何选择呢？除了png32表示的色彩更丰富，还有一点需要考虑，png8 透明图片的边缘会有毛刺，通过下面的图对比可以看得比较明显。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/convert_web_compare.png" alt=""></p>
<p>所以，以后如果你碰到一个类似我作坊的UI，请告诉他正确的切图方式，这是为他好，我担心他会失业。。。</p>
<h4 id="查看带alpha通道图片的alpha通道"><a href="#查看带alpha通道图片的alpha通道" class="headerlink" title="查看带alpha通道图片的alpha通道"></a>查看带alpha通道图片的alpha通道</h4><p>&emsp;在查阅alpha通道相关概念时，比较容易找到有关alpha通道概念的描述，但是比较难直观的查看alpha通道到底是咋样的，下面就介绍下怎样通过PS查看带alpha通道的图片的alpha通道</p>
<ul>
<li>以上面转换成web和设备的32位png为例，将图片拖动到PS</li>
<li>在图层栏，Ctrl + 鼠标点击图层</li>
<li>在通道栏，将选区存储为通道，然后就可以看到通道多了一个alpha通道，而这个alpha通道就是该图的alpha通道样式</li>
</ul>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/chanel_alpha.png" alt=""></p>
<p>在上图中，黑色区域就是透明区域，白色区域就是不透明区域，这样就是比较直观的看到图片的alpha通道的样子了。</p>
<h3 id="png-压缩"><a href="#png-压缩" class="headerlink" title="png 压缩"></a>png 压缩</h3><p> png图片的压缩包括有损压缩和无损压缩，有损压缩这里主要是指将图片转化成webp格式；无损压缩，这里我们是指通过Google提供的zopfli工具对png进行无损压缩。</p>
<h4 id="png转webp"><a href="#png转webp" class="headerlink" title="png转webp"></a>png转webp</h4><p>&emsp;在Android Studio中选择图片右击 &gt;&gt;Convert to WebP ,然后可以选择有损压缩和无损压缩以及其他的配置项，对于图片质量要求不高的可以选择有损压缩，然后定义适当的压缩比例。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/convert_to_webp.png" alt=""></p>
<h4 id="zopfli无损压缩png"><a href="#zopfli无损压缩png" class="headerlink" title="zopfli无损压缩png"></a>zopfli无损压缩png</h4><p> zopfli是Google开源的一款png无损压缩工具，可以将大多数png图片无损压缩10%左右，甚至可以达到30%。zopfli工具的使用请参考<a href="https://juejin.im/entry/578e3a34c4c971005e059ee9" target="_blank" rel="external">这里</a>,如果没有配置过local bin，配置过程可参考<a href="http://christinabergey.com/blog/2013/08/creating-a-bin-folder-on-mac-or-linux-systems/" target="_blank" rel="external">这里</a>。配置好zopfli环境（Mac/Linux）后，就可以通过zoplipng 命令压缩png图片了，一个个压缩比较麻烦，我们可以写个脚本，比如我的Python脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="comment">#iterate current director to find all png file,then compress it</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">transferFile</span><span class="params">()</span>:</span></div><div class="line">    list = os.listdir(<span class="string">'./'</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> list: <span class="comment"># </span></div><div class="line">        print(i)</div><div class="line">        <span class="keyword">if</span>(i.endswith(<span class="string">'.png'</span>)):</div><div class="line">           doTransfer(i) </div><div class="line">		   </div><div class="line"><span class="comment"># call zopflipng to compress png file 		   </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">doTransfer</span><span class="params">(i)</span>:</span></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">not</span> os.path.isdir(<span class="string">'zoped'</span>)):</div><div class="line">	    os.makedirs(<span class="string">'zoped'</span>)</div><div class="line">    os.system(<span class="string">'zopflipng '</span> + i + <span class="string">' ./zoped/'</span> + i) </div><div class="line">	</div><div class="line"><span class="comment">#delete the original png file </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">deletePng</span><span class="params">()</span>:</span></div><div class="line">    os.system(<span class="string">'rm ./*.png'</span>)</div><div class="line"></div><div class="line">transferFile()</div><div class="line">deletePng()</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;在对APK资源进行优化的时候，我们可以总结为以下几个方面考虑：</p>
<ul>
<li>删除无用资源文件；</li>
<li>选择正确格式的图片文件；</li>
<li>压缩图片文件</li>
</ul>
<p>参考：</p>
<p><a href="https://mp.weixin.qq.com/s/DZL3JjoeMu8vo01RPMFBsQ" target="_blank" rel="external">“追踪圣诞老人”— 每年最新API和应用开发技术的试验田</a></p>
<p><a href="https://dev.qq.com/topic/590fe41429d8be2a14b64da6" target="_blank" rel="external">Android APK 瘦身 - JOOX Music项目实战</a></p>
<p><a href="http://www.cnblogs.com/peunzhang/archive/2013/05/30/3050394.html" target="_blank" rel="external">PNG的使用技巧</a></p>
<p><a href="https://en.wikipedia.org/wiki/Portable_Network_Graphics" target="_blank" rel="external">Portable Network Graphics</a></p>
<p><a href="https://www.w3.org/TR/PNG/" target="_blank" rel="external">Portable Network Graphics (PNG) Specification</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/06/13/Android APK 瘦身实战（二）——资源文件优化/" data-id="cjbu74ywy000457vg6z6yqv5g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APK-瘦身/">APK 瘦身</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android APK 瘦身实战（一）——APK分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/21/Android APK 瘦身实战（一）——APK分析/" class="article-date">
  <time datetime="2017-05-20T22:43:30.000Z" itemprop="datePublished">2017-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/21/Android APK 瘦身实战（一）——APK分析/">Android APK 瘦身实战（一）——APK分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>在开始APK瘦身前，先要分析这个APK有多大，就像想减肥，得知道自己有多胖、每天喝几瓶可乐、吃几包薯条对吧。</p>
</blockquote>
<p> 在Android Studio2.2开始，推出了一个新的功能——APK Analyzer。APK Analyzer旨在帮助分析你的APK，查看你的APK各组成部分的大小。APK Analyzer使用很简单，可以通过三种方式打开：</p>
<ul>
<li>在Android Studio中找到你的APK，然后双击即可打开</li>
<li>直接把你的APK拖到Android Studio的编辑区域</li>
<li>Build&gt;Analyze APK ，然后选择要分析的APK</li>
</ul>
<p>打开后，显示的内容是这样的：</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/apk_analyze_view.png" alt="iamge"></p>
<p>从这里面我么可以看到APK各个组成部分的大小，其中：</p>
<ul>
<li><p>Raw File Size ：APK占用的空间大小</p>
</li>
<li><p>Download Size：下载该应用的大小</p>
</li>
<li><p>% of Total Download size ：占用下载大小的百分比</p>
<p>​</p>
</li>
</ul>
<h2 id="dex文件"><a href="#dex文件" class="headerlink" title="dex文件"></a>dex文件</h2><p>  在dex里面，我们能看到包和类的总引用个数，同时也能发现我们是否重复引用了相同的类，或者以前使用过的依赖包，后面没使用也打包进去了。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/apk_analyze_dex.png" alt="iamge"></p>
<p>Defined Methods 是指包或者类中定义的方法数。Referenced Method是DEX文件中引用的全部方法，它包含了你定义的方法、依赖的library、定义在标准Java和Android包中的方法。比如从dex中可以看到，我把kotlin打包进去了，但是其实在代中根本没有用到kotlin，只是之前在build.gradle增加了依赖，那么这个时候就可以把他从build.gradle中移除。</p>
<h2 id="资源文件"><a href="#资源文件" class="headerlink" title="资源文件"></a>资源文件</h2><p>&emsp;在res文件下可以看到应用里面的各个资源文件，比如应用的图片、布局文件、color资源等，然后在resource.arsc中可以看到string、id等的定义以及对应的值。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/apk_analyze_res.png" alt="iamge"></p>
<p>资源文件占了应用大小的很大一部分，这也是后面瘦身会比较关注的地方。</p>
<h2 id="应用对比"><a href="#应用对比" class="headerlink" title="应用对比"></a>应用对比</h2><p>在APK Analyzer中，我们可以比较两个应用的大小，比如我们在优化后，可以选择APK Analyzer窗口右上角的Compare with,选择未优化的APK进行比较，例如在我去掉了kotlin依赖后，对比应用是这样的：我们可以很直白的看到变化，dex比原来小了1.3M</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/apk_analyzye/apk_analyze_compare.png" alt="iamge"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/05/21/Android APK 瘦身实战（一）——APK分析/" data-id="cjbu74ywm000057vghk81iqw4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APK-瘦身/">APK 瘦身</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android TextClock 使用及源码解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/13/Android TextClock 使用及源码解析/" class="article-date">
  <time datetime="2017-05-12T23:29:30.000Z" itemprop="datePublished">2017-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/13/Android TextClock 使用及源码解析/">Android TextClock 使用及源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>TextClock 是Android用于显示当前时间或者日期的控件，并且支持用户自定义的日期或者时间格式。</p>
</blockquote>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p> 比如我们要做一个下面效果图的界面，这里我们就可以使用TextClock来实现。</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/text_clock/text_clock_render.png" alt="iamge"></p>
<h3 id="1，时间"><a href="#1，时间" class="headerlink" title="1，时间"></a>1，时间</h3><p> 上面效果图中的时间，我们该怎么做呢，我们可以用一个TextClock实现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextClock</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/main_date"</span></div><div class="line">    <span class="attr">style</span>=<span class="string">"@style/MainDateStyle"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"@dimen/main_date_width"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_marginTop</span>=<span class="string">"50dp"</span></div><div class="line">    <span class="attr">android:format12Hour</span>=<span class="string">"@string/main_date_format12"</span></div><div class="line">    <span class="attr">android:format24Hour</span>=<span class="string">"@string/main_date_format24"</span>/&gt;</div></pre></td></tr></table></figure>
<p>其中<code>android:format12Hour</code> 表示12小时制格式，<code>android:format24Hour</code> 表示24小时制格式，对应的string资源是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"main_date_format12"</span>&gt;</span>h &amp;#160;&amp;#160;&amp;#160;mm<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"main_date_format24"</span>&gt;</span>HH &amp;#160;&amp;#160;mm<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这里是通过<code>&amp;#160;</code> 来实现空格。但是这个时候就会有个问题：怎么识别不同的分辨率呢，因为中间的空格毕竟不好控制。嗯，或许你已经想到了，我们可以用两个TextClock来实现：一个表示小时，另一个表示分钟：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextClock</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/main_date"</span></div><div class="line">        <span class="attr">style</span>=<span class="string">"@style/MainDateStyle"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"@dimen/main_date_width"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"50dp"</span></div><div class="line">        <span class="attr">android:format12Hour</span>=<span class="string">"h"</span></div><div class="line">        <span class="attr">android:format24Hour</span>=<span class="string">"HH"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextClock</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/main_date1"</span></div><div class="line">        <span class="attr">style</span>=<span class="string">"@style/MainDateStyle"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"@dimen/main_date_width"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_marginStart</span>=<span class="string">"55dip"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"50dp"</span></div><div class="line">        <span class="attr">android:format12Hour</span>=<span class="string">"mm"</span></div><div class="line">        <span class="attr">android:format24Hour</span>=<span class="string">"mm"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="2，日期"><a href="#2，日期" class="headerlink" title="2，日期"></a>2，日期</h3><p> 对应日期的使用和时间类似，主要的还是修改<code>android:format12Hour</code> 和<code>android:format24Hour</code> ，就拿上面的效果图来讲，我们可以这样实现：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextClock</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/main_time"</span></div><div class="line">    <span class="attr">style</span>=<span class="string">"@style/MainTimeStyle"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></div><div class="line">    <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></div><div class="line">    <span class="attr">android:format12Hour</span>=<span class="string">"@string/main_time_format"</span></div><div class="line">    <span class="attr">android:format24Hour</span>=<span class="string">"@string/main_time_format"</span></div><div class="line">    <span class="attr">android:paddingBottom</span>=<span class="string">"30dp"</span>/&gt;</div></pre></td></tr></table></figure>
<p>对应的string文件定义如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--默认格式--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"main_time_format"</span>&gt;</span>yyyy/M/d &amp;#160;&amp;#160; EEE<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--中文格式--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"main_time_format"</span>&gt;</span>yyyy年M月d日&amp;#160;&amp;#160;EEE<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div></pre></td></tr></table></figure>
<p>整个布局文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@drawable/bg_date_time"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextClock</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/main_date"</span></div><div class="line">            <span class="attr">style</span>=<span class="string">"@style/MainDateStyle"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"@dimen/main_date_width"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40dp"</span></div><div class="line">            <span class="attr">android:format12Hour</span>=<span class="string">"h"</span></div><div class="line">            <span class="attr">android:format24Hour</span>=<span class="string">"HH"</span>/&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextClock</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/main_date1"</span></div><div class="line">            <span class="attr">style</span>=<span class="string">"@style/MainDateStyle"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"@dimen/main_date_width"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginStart</span>=<span class="string">"55dip"</span></div><div class="line">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40dp"</span></div><div class="line">            <span class="attr">android:format12Hour</span>=<span class="string">"mm"</span></div><div class="line">            <span class="attr">android:format24Hour</span>=<span class="string">"mm"</span>/&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextClock</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/main_time"</span></div><div class="line">        <span class="attr">style</span>=<span class="string">"@style/MainTimeStyle"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:paddingBottom</span>=<span class="string">"30dp"</span></div><div class="line">        <span class="attr">android:format12Hour</span>=<span class="string">"@string/main_time_format"</span></div><div class="line">        <span class="attr">android:format24Hour</span>=<span class="string">"@string/main_time_format"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p> TextClock使用很简单，主要就是设置他的<code>android:format12Hour</code> 和<code>android:format24Hour</code> 属性。那么问题来了，改怎么设置呢？可以先参考Android开发文档中的<a href="https://developer.android.google.cn/reference/java/text/SimpleDateFormat.html" target="_blank" rel="external">SimpleDateFormat</a> ，其中列出了已经定义的字母代表的含义，并且也指明了可以通过加上<code>&#39;&#39;</code> 单引号来避免被替换。比如我需要“ 2017X4X6”这样的日期格式，那么可以这样定义:<code>yyyy&#39;X&#39;M&#39;X&#39;d</code> ，或许你看了SimpleDateFromat文档后，你也会这样定义成<code>YYYY&#39;X&#39;M&#39;X&#39;d</code> ，但是你会发现你得到的结果是这样的：YYYYX4X6，为什么呢，稍后我们从源码的角度来解答。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="1，时间更新机制"><a href="#1，时间更新机制" class="headerlink" title="1，时间更新机制"></a>1，时间更新机制</h3><p> TextClock是继承自TextView，TextClock有四个构造方法，在布局文件中使用TextClock时，最终都会调用<code>public TextClock(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes)</code> 这个构造方法，所以我们从该构造方法入手，分析TextClock的原理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">TextClock</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr, <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs, defStyleAttr, defStyleRes);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TypedArray a = context.obtainStyledAttributes(</div><div class="line">            attrs, R.styleable.TextClock, defStyleAttr, defStyleRes);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//获取xml中定义的12小时制、24小时制、时区的格式</span></div><div class="line">        mFormat12 = a.getText(R.styleable.TextClock_format12Hour);</div><div class="line">        mFormat24 = a.getText(R.styleable.TextClock_format24Hour);</div><div class="line">        mTimeZone = a.getString(R.styleable.TextClock_timeZone);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        a.recycle();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    init();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 在上面的构造方法中调用了init()方法，该方法先会确保12小时和24小时制的格式有正确的值，然后会创建Calendar对象mTimer，该对象就是正真的时间，所定义的format都是操作mTimer，然后得到相应格式的时间、日期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//如果在xml中没有定义12小时制或者24小时制的格式就取系统的时间格式</span></div><div class="line">    <span class="keyword">if</span> (mFormat12 == <span class="keyword">null</span> || mFormat24 == <span class="keyword">null</span>) &#123;</div><div class="line">        LocaleData ld = LocaleData.get(getContext().getResources().getConfiguration().locale);</div><div class="line">        <span class="keyword">if</span> (mFormat12 == <span class="keyword">null</span>) &#123;</div><div class="line">            mFormat12 = ld.timeFormat12;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mFormat24 == <span class="keyword">null</span>) &#123;</div><div class="line">            mFormat24 = ld.timeFormat24;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//创建Calender对象mTimer</span></div><div class="line">    createTime(mTimeZone);</div><div class="line">    <span class="comment">// Wait until onAttachedToWindow() to handle the ticker</span></div><div class="line">    chooseFormat(<span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> createTime()方法比较简单，我们直接看chooseFormat()方法,该方法会先确定时间日期格式,是12小时制还是24小时制，我们这里为了方便，将这确定的格式称为<strong>确定的格式</strong>，然后根据确定的格式判断要不要开始每秒更新时间显示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Selects either one of &#123;<span class="doctag">@link</span> #getFormat12Hour()&#125; or &#123;<span class="doctag">@link</span> #getFormat24Hour()&#125;</div><div class="line"> * depending on whether the user has selected 24-hour format.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> handleTicker true if calling this method should schedule/unschedule the</div><div class="line"> *                     time ticker, false otherwise</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">chooseFormat</span><span class="params">(<span class="keyword">boolean</span> handleTicker)</span> </span>&#123;</div><div class="line">    <span class="comment">//根据系统设置判断是否是24小时制</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> format24Requested = is24HourModeEnabled();</div><div class="line">    <span class="comment">//LoacalData是支持ICU的类，主要是为了支持国际化</span></div><div class="line">    LocaleData ld = LocaleData.get(getContext().getResources().getConfiguration().locale);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (format24Requested) &#123;</div><div class="line">		<span class="comment">//abc(CharSequence a, CharSequence b, CharSequence c),是判断a是否为null，不为null就返回a的值，</span></div><div class="line">		<span class="comment">//如果a为null,则继续判断b是否为null,以此类推下去</span></div><div class="line">        mFormat = abc(mFormat24, mFormat12, ld.timeFormat24);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mFormat = abc(mFormat12, mFormat24, ld.timeFormat12);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//hadSeconds 记录之前的值</span></div><div class="line">    <span class="keyword">boolean</span> hadSeconds = mHasSeconds;</div><div class="line">	<span class="comment">//判断当前格式中是否包含秒</span></div><div class="line">    mHasSeconds = DateFormat.hasSeconds(mFormat);</div><div class="line">    <span class="comment">//handleTicker参数、onAttachedToWindow()是否被调用，mHaseSeconds值是否有改变，</span></div><div class="line">    <span class="comment">//当三个参数都为true时，才会根据mHaseSeconds之前的状态，来判断是否需要每秒更新时间</span></div><div class="line">    <span class="keyword">if</span> (handleTicker &amp;&amp; mAttached &amp;&amp; hadSeconds != mHasSeconds) &#123;</div><div class="line">        <span class="keyword">if</span> (hadSeconds) getHandler().removeCallbacks(mTicker);</div><div class="line">        <span class="keyword">else</span> mTicker.run();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看下mTicker变量的初始化，mTicker 是个一个实现了Runnale接口的匿名内部类对象。mTicker就是用于每秒更新时间的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable mTicker = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//更新时间</span></div><div class="line">        onTimeChanged();</div><div class="line"></div><div class="line">        <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">        <span class="keyword">long</span> next = now + (<span class="number">1000</span> - now % <span class="number">1000</span>);<span class="comment">//下一个整数秒再次更新时间</span></div><div class="line"></div><div class="line">        getHandler().postAtTime(mTicker, next);<span class="comment">//通过Handler自发自收消息</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//更新时间显示</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTimeChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">    mTime.setTimeInMillis(System.currentTimeMillis());</div><div class="line">    setText(DateFormat.format(mFormat, mTime));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有哪些地方会去启动这一个更新时间的任务，也就是调用mTicker.run()呢。在上面提到的chooseFormat(boolean handleTicker)中会调用，另一处是在onAttachedToWindow()方法中也会调用。我们看下onAttachedToWindow（）的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onAttachedToWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onAttachedToWindow();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!mAttached) &#123;</div><div class="line">        mAttached = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        registerReceiver(); <span class="comment">//注册广播</span></div><div class="line">        registerObserver(); <span class="comment">//注册ContentObserver，监听SettingProvider中时间日期格式等的改变</span></div><div class="line"></div><div class="line">        createTime(mTimeZone);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mHasSeconds) &#123; <span class="comment">//判断确定的格式中是否包含秒</span></div><div class="line">            mTicker.run();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            onTimeChanged();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 我们可以看到，在onAttachedToWindow()方法中，会根据确定的格式中是否包含秒，如果包含就开始每秒更新一次时间日期显示。或许你我提出个问题，上面我们一直提到，确定的格式中包含秒时，才会每秒去更新时间日期显示，如果不包含，那时间怎么更新呢？难道就不能更新了？我们看看registerReceiver()方法以及注册的广播。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerReceiver</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> IntentFilter filter = <span class="keyword">new</span> IntentFilter();</div><div class="line">    <span class="comment">//ACTION_TIME_TICK是系统每分钟发出，通过这个广播实现了在没调用mTicker.run()方法时仍能更新时间</span></div><div class="line">    filter.addAction(Intent.ACTION_TIME_TICK);</div><div class="line">    filter.addAction(Intent.ACTION_TIME_CHANGED);</div><div class="line">    filter.addAction(Intent.ACTION_TIMEZONE_CHANGED);</div><div class="line"></div><div class="line">    getContext().registerReceiver(mIntentReceiver, filter, <span class="keyword">null</span>, getHandler());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mIntentReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mTimeZone == <span class="keyword">null</span> &amp;&amp; Intent.ACTION_TIMEZONE_CHANGED.equals(intent.getAction())) &#123;</div><div class="line">            <span class="keyword">final</span> String timeZone = intent.getStringExtra(<span class="string">"time-zone"</span>);</div><div class="line">            createTime(timeZone);</div><div class="line">        &#125;</div><div class="line">        onTimeChanged();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">/**</span></div><div class="line">* 更新时间</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTimeChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">    mTime.setTimeInMillis(System.currentTimeMillis());</div><div class="line">    setText(DateFormat.format(mFormat, mTime));</div><div class="line">    setContentDescription(DateFormat.format(mDescFormat, mTime));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 最后，我们通过一张流程图来总结下：</p>
<p><img src="http://oq6yfhskd.bkt.clouddn.com/blog/text_clock/textclokc_flow_chart.png" alt="image"></p>
<h3 id="2，格式匹配方式"><a href="#2，格式匹配方式" class="headerlink" title="2，格式匹配方式"></a>2，格式匹配方式</h3><p> 在了解时间日期更新机制之后，我们看下当设置时间或者日期格式后，为什么就能够返回我们想要的格式？为什么在上一节，我们最后提到的设置格式<code>YYYY&#39;X&#39;M&#39;X&#39;d</code> 不能返回我们期望的日期格式。再看下onTimeChange()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTimeChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">    mTime.setTimeInMillis(System.currentTimeMillis());</div><div class="line">    setText(DateFormat.format(mFormat, mTime));</div><div class="line">    setContentDescription(DateFormat.format(mDescFormat, mTime));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更新时间显示是通过调用了<code>setText(DateFormat.format(mFormat, mTime));</code> 方法，那么就可以继续看DateFormat.format()具体的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"> * Given a format string and a &#123;<span class="doctag">@link</span> java.util.Calendar&#125; object, returns a CharSequence</div><div class="line"> * containing the requested date.</div><div class="line"> * <span class="doctag">@param</span> inFormat the format string, as described in &#123;<span class="doctag">@link</span> android.text.format.DateFormat&#125;</div><div class="line"> * <span class="doctag">@param</span> inDate the date to format</div><div class="line"> * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> CharSequence&#125; containing the requested text</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CharSequence <span class="title">format</span><span class="params">(CharSequence inFormat, Calendar inDate)</span> </span>&#123;</div><div class="line">    SpannableStringBuilder s = <span class="keyword">new</span> SpannableStringBuilder(inFormat);<span class="comment">//将inFormat转化可变的字符串</span></div><div class="line">    <span class="keyword">int</span> count;</div><div class="line"></div><div class="line">    LocaleData localeData = LocaleData.get(Locale.getDefault());</div><div class="line"></div><div class="line">    <span class="keyword">int</span> len = inFormat.length();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i += count) &#123;</div><div class="line">        count = <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> c = s.charAt(i);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (c == QUOTE) &#123;</div><div class="line">            count = appendQuotedText(s, i, len);</div><div class="line">            len = s.length();</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> ((i + count &lt; len) &amp;&amp; (s.charAt(i + count) == c)) &#123;</div><div class="line">            count++;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//replacement就是要替换inFormat中的时间日期的内容；比如inFormat是：“mm:ss”,当前时间是12分23秒</span></div><div class="line">		<span class="comment">//如果c为第一个“m”,那么replacement 就是“1”，</span></div><div class="line">        String replacement;</div><div class="line">        <span class="keyword">switch</span> (c) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="string">'A'</span>:   <span class="comment">// 24小时制中的上午或者下午标志</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'a'</span>:</div><div class="line">                replacement = localeData.amPm[inDate.get(Calendar.AM_PM) - Calendar.AM];</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'d'</span>:  <span class="comment">// 一个月中第几天</span></div><div class="line">                replacement = zeroPad(inDate.get(Calendar.DATE), count);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'c'</span>: <span class="comment">// 星期几</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'E'</span>:</div><div class="line">                replacement = getDayOfWeekString(localeData,</div><div class="line">                                                 inDate.get(Calendar.DAY_OF_WEEK), count, c);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'K'</span>: <span class="comment">// hour in am/pm (0-11)  </span></div><div class="line">            <span class="keyword">case</span> <span class="string">'h'</span>: <span class="comment">// hour in am/pm (1-12)</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">int</span> hour = inDate.get(Calendar.HOUR);</div><div class="line">                    <span class="keyword">if</span> (c == <span class="string">'h'</span> &amp;&amp; hour == <span class="number">0</span>) &#123;</div><div class="line">                        hour = <span class="number">12</span>;</div><div class="line">                    &#125;</div><div class="line">                    replacement = zeroPad(hour, count);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'H'</span>: <span class="comment">// hour in day (0-23)</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'k'</span>: <span class="comment">// hour in day (1-24) [but see note below]</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">int</span> hour = inDate.get(Calendar.HOUR_OF_DAY);</div><div class="line">                    <span class="comment">// Historically on Android 'k' was interpreted as 'H', which wasn't</span></div><div class="line">                    <span class="comment">// implemented, so pretty much all callers that want to format 24-hour</span></div><div class="line">                    <span class="comment">// times are abusing 'k'. http://b/8359981.</span></div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">false</span> &amp;&amp; c == <span class="string">'k'</span> &amp;&amp; hour == <span class="number">0</span>) &#123;</div><div class="line">                        hour = <span class="number">24</span>;</div><div class="line">                    &#125;</div><div class="line">                    replacement = zeroPad(hour, count);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'L'</span>: <span class="comment">//一年中的月份</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'M'</span>:</div><div class="line">                replacement = getMonthString(localeData,</div><div class="line">                                             inDate.get(Calendar.MONTH), count, c);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'m'</span>: <span class="comment">//一小时中的第几分钟</span></div><div class="line">                replacement = zeroPad(inDate.get(Calendar.MINUTE), count);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'s'</span>: <span class="comment">//一分钟第几秒</span></div><div class="line">                replacement = zeroPad(inDate.get(Calendar.SECOND), count);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'y'</span>: <span class="comment">//年份</span></div><div class="line">                replacement = getYearString(inDate.get(Calendar.YEAR), count);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'z'</span>: <span class="comment">//时区</span></div><div class="line">                replacement = getTimeZoneString(inDate, count);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                replacement = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (replacement != <span class="keyword">null</span>) &#123;</div><div class="line">            s.replace(i, i + count, replacement); <span class="comment">//替换时间日期格式中对应的字符（即上面case 语句中的字符）</span></div><div class="line">            count = replacement.length(); <span class="comment">// CARE: count is used in the for loop above</span></div><div class="line">            len = s.length();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (inFormat <span class="keyword">instanceof</span> Spanned) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpannedString(s);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> s.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过这个方法，我们会发现该方法里面定义的格式的字符和<a href="https://developer.android.google.cn/reference/java/text/SimpleDateFormat.html" target="_blank" rel="external">SimpleDateFormat</a> 中列举的是有出入的，这也解释了在使用的章节里面，最后的一个问题：为什么<code>YYYY&#39;X&#39;M&#39;X&#39;d</code> 不能得到我们期望的日期。因为在DateFormat.format()方法中的case语句中根本没有格式”Y” 啊！   <strong>所以当我们在定义TextClock的format时最好的方式就是参考DateFormat.format()方法，看看它支持哪些格式</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/05/13/Android TextClock 使用及源码解析/" data-id="cjbu74yx1000557vgvhqolqcw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TextClock/">TextClock</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/APK-瘦身/">APK 瘦身</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-Studio/">Android Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lifecycle/">Lifecycle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LiveData/">LiveData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spinner/">Spinner</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TextClock/">TextClock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thread/">Thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ViewModel/">ViewModel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自定义View/">自定义View</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/APK-瘦身/" style="font-size: 13.33px;">APK 瘦身</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Android-Studio/" style="font-size: 10px;">Android Studio</a> <a href="/tags/Java/" style="font-size: 16.67px;">Java</a> <a href="/tags/Lifecycle/" style="font-size: 10px;">Lifecycle</a> <a href="/tags/LiveData/" style="font-size: 10px;">LiveData</a> <a href="/tags/Spinner/" style="font-size: 10px;">Spinner</a> <a href="/tags/TextClock/" style="font-size: 10px;">TextClock</a> <a href="/tags/Thread/" style="font-size: 13.33px;">Thread</a> <a href="/tags/ViewModel/" style="font-size: 10px;">ViewModel</a> <a href="/tags/架构/" style="font-size: 16.67px;">架构</a> <a href="/tags/自定义View/" style="font-size: 10px;">自定义View</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/12/28/Android架构组件（三）——ViewModel/">Android架构组件（三）——ViewModel</a>
          </li>
        
          <li>
            <a href="/2017/12/23/Android架构组件（二）——LiveData/">Android 架构组件（二）——LiveData</a>
          </li>
        
          <li>
            <a href="/2017/12/02/Android 架构组件（一）——Lifecycle-Aware Components/">Android 架构组件（一）——Lifecycle-Aware Components</a>
          </li>
        
          <li>
            <a href="/2017/11/11/Java两种创建线程方式原理解析/">Java两种创建线程方式原理解析</a>
          </li>
        
          <li>
            <a href="/2017/07/23/如何正确的给ViewGroup设置OnClickListener/">如何正确的给ViewGroup设置OnClickListener</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 ShymanZhu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>